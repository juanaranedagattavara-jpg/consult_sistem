---
phase: 01-foundation
plan: 05
type: execute
wave: 3
depends_on: ["01-02", "01-04"]
files_modified:
  - src/app/(dashboard)/dashboard/settings/page.tsx
  - src/app/(dashboard)/dashboard/settings/layout.tsx
  - src/app/(dashboard)/dashboard/team/page.tsx
  - src/components/settings/clinic-form.tsx
  - src/components/settings/bot-config-form.tsx
  - src/components/settings/time-config-form.tsx
  - src/components/settings/patient-fields-form.tsx
  - src/components/settings/staff-invitation-form.tsx
  - src/components/settings/staff-list.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can access /dashboard/settings"
    - "Staff cannot access /dashboard/settings (redirected)"
    - "Admin can edit clinic name and phone"
    - "Admin can configure bot settings"
    - "Admin can configure time/schedule settings"
    - "Admin can add/remove custom patient fields"
    - "Admin can invite staff via email"
    - "Admin can see list of staff members"
  artifacts:
    - path: "src/app/(dashboard)/dashboard/settings/page.tsx"
      provides: "Settings page with tabs"
      min_lines: 30
    - path: "src/components/settings/clinic-form.tsx"
      provides: "Clinic edit form"
      contains: "updateClinic"
    - path: "src/components/settings/bot-config-form.tsx"
      provides: "Bot configuration form"
      contains: "botConfig"
    - path: "src/components/settings/patient-fields-form.tsx"
      provides: "Patient fields configuration"
      contains: "patientFields"
    - path: "src/components/settings/staff-invitation-form.tsx"
      provides: "Staff invitation form"
      contains: "inviteStaff"
  key_links:
    - from: "src/components/settings/clinic-form.tsx"
      to: "convex/clinics.ts"
      via: "updateClinic mutation"
      pattern: "updateClinic"
    - from: "src/components/settings/staff-invitation-form.tsx"
      to: "convex/clinics.ts"
      via: "inviteStaff mutation"
      pattern: "inviteStaff"
---

<objective>
Build the complete clinic settings pages including general settings, bot configuration, time/schedule configuration, custom patient fields, and staff management (invitation system).

Purpose: Fulfill requirements CLIN-01 through CLIN-04 and enable admin to manage their clinic configuration.
Output: Working settings pages with all configuration forms and staff management.
</objective>

<context>
@.planning/phases/01-foundation/01-02-SUMMARY.md (for Convex mutations)
@.planning/phases/01-foundation/01-04-SUMMARY.md (for dashboard layout)

Dependencies:
- Convex mutations: updateClinic, inviteStaff, getClinicStaff
- Convex queries: getCurrentClinic
- shadcn/ui components: Tabs, Card, Input, Button, Form, Switch, Select

Settings structure (tabs):
1. General - Clinic name, phone
2. Bot - Enable/disable, welcome message, language
3. Horarios - Timezone, working hours, appointment duration, buffer
4. Campos Paciente - Custom patient fields (text, number, date, select)
5. Equipo (separate page) - Staff list, invitations
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create settings page with tabs layout</name>
  <files>
    src/app/(dashboard)/dashboard/settings/page.tsx
    src/app/(dashboard)/dashboard/settings/layout.tsx
    src/components/settings/settings-tabs.tsx
  </files>
  <action>
    1. Install additional shadcn components:
    ```bash
    npx shadcn@latest add switch select textarea
    ```

    2. Create src/app/(dashboard)/dashboard/settings/layout.tsx:
    ```typescript
    "use client";

    import { useAuth } from "@/hooks/use-auth";
    import { useRouter } from "next/navigation";
    import { useEffect } from "react";

    export default function SettingsLayout({
      children,
    }: {
      children: React.ReactNode;
    }) {
      const { user, isLoading } = useAuth();
      const router = useRouter();

      useEffect(() => {
        // Only admins can access settings
        if (!isLoading && user && user.role !== "admin") {
          router.push("/dashboard");
        }
      }, [isLoading, user, router]);

      if (isLoading) {
        return (
          <div className="flex items-center justify-center py-12">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary" />
          </div>
        );
      }

      if (user?.role !== "admin") {
        return null;
      }

      return <>{children}</>;
    }
    ```

    3. Create src/components/settings/settings-tabs.tsx:
    ```typescript
    "use client";

    import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
    import { ClinicForm } from "./clinic-form";
    import { BotConfigForm } from "./bot-config-form";
    import { TimeConfigForm } from "./time-config-form";
    import { PatientFieldsForm } from "./patient-fields-form";

    export function SettingsTabs() {
      return (
        <Tabs defaultValue="general" className="space-y-4">
          <TabsList className="grid w-full grid-cols-4">
            <TabsTrigger value="general">General</TabsTrigger>
            <TabsTrigger value="bot">Bot</TabsTrigger>
            <TabsTrigger value="horarios">Horarios</TabsTrigger>
            <TabsTrigger value="campos">Campos Paciente</TabsTrigger>
          </TabsList>

          <TabsContent value="general" className="space-y-4">
            <ClinicForm />
          </TabsContent>

          <TabsContent value="bot" className="space-y-4">
            <BotConfigForm />
          </TabsContent>

          <TabsContent value="horarios" className="space-y-4">
            <TimeConfigForm />
          </TabsContent>

          <TabsContent value="campos" className="space-y-4">
            <PatientFieldsForm />
          </TabsContent>
        </Tabs>
      );
    }
    ```

    4. Create src/app/(dashboard)/dashboard/settings/page.tsx:
    ```typescript
    import { SettingsTabs } from "@/components/settings/settings-tabs";

    export default function SettingsPage() {
      return (
        <div className="space-y-6">
          <div>
            <h1 className="text-3xl font-bold tracking-tight">Configuracion</h1>
            <p className="text-muted-foreground">
              Administra la configuracion de tu clinica
            </p>
          </div>

          <SettingsTabs />
        </div>
      );
    }
    ```
  </action>
  <verify>
    - /dashboard/settings page loads with tabs
    - Non-admin users redirected to /dashboard
    - Tabs switch content correctly
  </verify>
  <done>
    Settings page with tabbed layout and admin-only access control
  </done>
</task>

<task type="auto">
  <name>Task 2: Build configuration forms (clinic, bot, time)</name>
  <files>
    src/components/settings/clinic-form.tsx
    src/components/settings/bot-config-form.tsx
    src/components/settings/time-config-form.tsx
  </files>
  <action>
    1. Create src/components/settings/clinic-form.tsx:
    ```typescript
    "use client";

    import { useState, useEffect } from "react";
    import { useForm } from "react-hook-form";
    import { zodResolver } from "@hookform/resolvers/zod";
    import { z } from "zod";
    import { useQuery, useMutation } from "convex/react";
    import { api } from "../../../../convex/_generated/api";
    import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
    import { Button } from "@/components/ui/button";
    import { Input } from "@/components/ui/input";
    import { Label } from "@/components/ui/label";

    const clinicSchema = z.object({
      name: z.string().min(2, "Name must be at least 2 characters"),
      phone: z.string().min(6, "Please enter a valid phone"),
    });

    type ClinicFormData = z.infer<typeof clinicSchema>;

    export function ClinicForm() {
      const [isSaving, setIsSaving] = useState(false);
      const [success, setSuccess] = useState(false);

      const clinic = useQuery(api.clinics.getCurrentClinic);
      const updateClinic = useMutation(api.clinics.updateClinic);

      const form = useForm<ClinicFormData>({
        resolver: zodResolver(clinicSchema),
        defaultValues: {
          name: "",
          phone: "",
        },
      });

      // Update form when clinic data loads
      useEffect(() => {
        if (clinic) {
          form.reset({
            name: clinic.name,
            phone: clinic.phone,
          });
        }
      }, [clinic, form]);

      const onSubmit = async (data: ClinicFormData) => {
        setIsSaving(true);
        setSuccess(false);
        try {
          await updateClinic({
            name: data.name,
            phone: data.phone,
          });
          setSuccess(true);
          setTimeout(() => setSuccess(false), 3000);
        } catch (error) {
          console.error("Failed to update clinic:", error);
        } finally {
          setIsSaving(false);
        }
      };

      return (
        <Card>
          <CardHeader>
            <CardTitle>Datos de la Clinica</CardTitle>
            <CardDescription>
              Informacion basica de tu clinica dental
            </CardDescription>
          </CardHeader>
          <CardContent>
            <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
              <div className="space-y-2">
                <Label htmlFor="name">Nombre de la clinica</Label>
                <Input
                  id="name"
                  {...form.register("name")}
                />
                {form.formState.errors.name && (
                  <p className="text-sm text-red-500">{form.formState.errors.name.message}</p>
                )}
              </div>

              <div className="space-y-2">
                <Label htmlFor="phone">Telefono</Label>
                <Input
                  id="phone"
                  {...form.register("phone")}
                />
                {form.formState.errors.phone && (
                  <p className="text-sm text-red-500">{form.formState.errors.phone.message}</p>
                )}
              </div>

              <div className="flex items-center gap-2">
                <Button type="submit" disabled={isSaving}>
                  {isSaving ? "Guardando..." : "Guardar cambios"}
                </Button>
                {success && (
                  <span className="text-sm text-green-600">Guardado correctamente</span>
                )}
              </div>
            </form>
          </CardContent>
        </Card>
      );
    }
    ```

    2. Create src/components/settings/bot-config-form.tsx:
    ```typescript
    "use client";

    import { useState, useEffect } from "react";
    import { useForm } from "react-hook-form";
    import { zodResolver } from "@hookform/resolvers/zod";
    import { z } from "zod";
    import { useQuery, useMutation } from "convex/react";
    import { api } from "../../../../convex/_generated/api";
    import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
    import { Button } from "@/components/ui/button";
    import { Input } from "@/components/ui/input";
    import { Label } from "@/components/ui/label";
    import { Switch } from "@/components/ui/switch";
    import { Textarea } from "@/components/ui/textarea";
    import {
      Select,
      SelectContent,
      SelectItem,
      SelectTrigger,
      SelectValue,
    } from "@/components/ui/select";

    const botConfigSchema = z.object({
      enabled: z.boolean(),
      welcomeMessage: z.string().optional(),
      language: z.string().optional(),
    });

    type BotConfigFormData = z.infer<typeof botConfigSchema>;

    export function BotConfigForm() {
      const [isSaving, setIsSaving] = useState(false);
      const [success, setSuccess] = useState(false);

      const clinic = useQuery(api.clinics.getCurrentClinic);
      const updateClinic = useMutation(api.clinics.updateClinic);

      const form = useForm<BotConfigFormData>({
        resolver: zodResolver(botConfigSchema),
        defaultValues: {
          enabled: false,
          welcomeMessage: "",
          language: "es",
        },
      });

      useEffect(() => {
        if (clinic?.botConfig) {
          form.reset({
            enabled: clinic.botConfig.enabled,
            welcomeMessage: clinic.botConfig.welcomeMessage || "",
            language: clinic.botConfig.language || "es",
          });
        }
      }, [clinic, form]);

      const onSubmit = async (data: BotConfigFormData) => {
        setIsSaving(true);
        setSuccess(false);
        try {
          await updateClinic({
            botConfig: {
              enabled: data.enabled,
              welcomeMessage: data.welcomeMessage,
              language: data.language,
            },
          });
          setSuccess(true);
          setTimeout(() => setSuccess(false), 3000);
        } catch (error) {
          console.error("Failed to update bot config:", error);
        } finally {
          setIsSaving(false);
        }
      };

      return (
        <Card>
          <CardHeader>
            <CardTitle>Configuracion del Bot</CardTitle>
            <CardDescription>
              Configura el bot de WhatsApp para tu clinica
            </CardDescription>
          </CardHeader>
          <CardContent>
            <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
              <div className="flex items-center justify-between">
                <div className="space-y-0.5">
                  <Label htmlFor="enabled">Bot activo</Label>
                  <p className="text-sm text-muted-foreground">
                    Activa o desactiva el bot de WhatsApp
                  </p>
                </div>
                <Switch
                  id="enabled"
                  checked={form.watch("enabled")}
                  onCheckedChange={(checked) => form.setValue("enabled", checked)}
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="language">Idioma</Label>
                <Select
                  value={form.watch("language")}
                  onValueChange={(value) => form.setValue("language", value)}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Selecciona idioma" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="es">Espanol</SelectItem>
                    <SelectItem value="en">English</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="welcomeMessage">Mensaje de bienvenida</Label>
                <Textarea
                  id="welcomeMessage"
                  placeholder="Hola! Bienvenido a nuestra clinica dental..."
                  {...form.register("welcomeMessage")}
                />
                <p className="text-sm text-muted-foreground">
                  Este mensaje se envia cuando un paciente contacta por primera vez
                </p>
              </div>

              <div className="flex items-center gap-2">
                <Button type="submit" disabled={isSaving}>
                  {isSaving ? "Guardando..." : "Guardar cambios"}
                </Button>
                {success && (
                  <span className="text-sm text-green-600">Guardado correctamente</span>
                )}
              </div>
            </form>
          </CardContent>
        </Card>
      );
    }
    ```

    3. Create src/components/settings/time-config-form.tsx:
    ```typescript
    "use client";

    import { useState, useEffect } from "react";
    import { useForm } from "react-hook-form";
    import { zodResolver } from "@hookform/resolvers/zod";
    import { z } from "zod";
    import { useQuery, useMutation } from "convex/react";
    import { api } from "../../../../convex/_generated/api";
    import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
    import { Button } from "@/components/ui/button";
    import { Input } from "@/components/ui/input";
    import { Label } from "@/components/ui/label";
    import {
      Select,
      SelectContent,
      SelectItem,
      SelectTrigger,
      SelectValue,
    } from "@/components/ui/select";

    const timeConfigSchema = z.object({
      timezone: z.string(),
      workingHoursStart: z.string(),
      workingHoursEnd: z.string(),
      appointmentDuration: z.number().min(15).max(180),
      bufferTime: z.number().min(0).max(60),
    });

    type TimeConfigFormData = z.infer<typeof timeConfigSchema>;

    const timezones = [
      { value: "America/Santiago", label: "Santiago, Chile (GMT-3/-4)" },
      { value: "America/Lima", label: "Lima, Peru (GMT-5)" },
      { value: "America/Bogota", label: "Bogota, Colombia (GMT-5)" },
      { value: "America/Mexico_City", label: "Ciudad de Mexico (GMT-6)" },
      { value: "America/Buenos_Aires", label: "Buenos Aires, Argentina (GMT-3)" },
    ];

    export function TimeConfigForm() {
      const [isSaving, setIsSaving] = useState(false);
      const [success, setSuccess] = useState(false);

      const clinic = useQuery(api.clinics.getCurrentClinic);
      const updateClinic = useMutation(api.clinics.updateClinic);

      const form = useForm<TimeConfigFormData>({
        resolver: zodResolver(timeConfigSchema),
        defaultValues: {
          timezone: "America/Santiago",
          workingHoursStart: "09:00",
          workingHoursEnd: "18:00",
          appointmentDuration: 30,
          bufferTime: 15,
        },
      });

      useEffect(() => {
        if (clinic?.timeConfig) {
          form.reset({
            timezone: clinic.timeConfig.timezone,
            workingHoursStart: clinic.timeConfig.workingHours.start,
            workingHoursEnd: clinic.timeConfig.workingHours.end,
            appointmentDuration: clinic.timeConfig.appointmentDuration,
            bufferTime: clinic.timeConfig.bufferTime,
          });
        }
      }, [clinic, form]);

      const onSubmit = async (data: TimeConfigFormData) => {
        setIsSaving(true);
        setSuccess(false);
        try {
          await updateClinic({
            timeConfig: {
              timezone: data.timezone,
              workingHours: {
                start: data.workingHoursStart,
                end: data.workingHoursEnd,
              },
              appointmentDuration: data.appointmentDuration,
              bufferTime: data.bufferTime,
            },
          });
          setSuccess(true);
          setTimeout(() => setSuccess(false), 3000);
        } catch (error) {
          console.error("Failed to update time config:", error);
        } finally {
          setIsSaving(false);
        }
      };

      return (
        <Card>
          <CardHeader>
            <CardTitle>Configuracion de Horarios</CardTitle>
            <CardDescription>
              Define los horarios de atencion y duracion de citas
            </CardDescription>
          </CardHeader>
          <CardContent>
            <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
              <div className="space-y-2">
                <Label>Zona horaria</Label>
                <Select
                  value={form.watch("timezone")}
                  onValueChange={(value) => form.setValue("timezone", value)}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Selecciona zona horaria" />
                  </SelectTrigger>
                  <SelectContent>
                    {timezones.map((tz) => (
                      <SelectItem key={tz.value} value={tz.value}>
                        {tz.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="workingHoursStart">Hora inicio</Label>
                  <Input
                    id="workingHoursStart"
                    type="time"
                    {...form.register("workingHoursStart")}
                  />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="workingHoursEnd">Hora termino</Label>
                  <Input
                    id="workingHoursEnd"
                    type="time"
                    {...form.register("workingHoursEnd")}
                  />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="appointmentDuration">Duracion cita (minutos)</Label>
                  <Input
                    id="appointmentDuration"
                    type="number"
                    min={15}
                    max={180}
                    {...form.register("appointmentDuration", { valueAsNumber: true })}
                  />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="bufferTime">Tiempo entre citas (minutos)</Label>
                  <Input
                    id="bufferTime"
                    type="number"
                    min={0}
                    max={60}
                    {...form.register("bufferTime", { valueAsNumber: true })}
                  />
                </div>
              </div>

              <div className="flex items-center gap-2">
                <Button type="submit" disabled={isSaving}>
                  {isSaving ? "Guardando..." : "Guardar cambios"}
                </Button>
                {success && (
                  <span className="text-sm text-green-600">Guardado correctamente</span>
                )}
              </div>
            </form>
          </CardContent>
        </Card>
      );
    }
    ```
  </action>
  <verify>
    - Clinic form shows current values and saves changes
    - Bot config form toggles enabled, saves message
    - Time config form saves timezone, hours, duration
    - "Saved" message appears after successful save
  </verify>
  <done>
    Configuration forms for clinic data, bot settings, and time/schedule settings complete
  </done>
</task>

<task type="auto">
  <name>Task 3: Build patient fields and staff management</name>
  <files>
    src/components/settings/patient-fields-form.tsx
    src/app/(dashboard)/dashboard/team/page.tsx
    src/components/settings/staff-invitation-form.tsx
    src/components/settings/staff-list.tsx
  </files>
  <action>
    1. Create src/components/settings/patient-fields-form.tsx:
    ```typescript
    "use client";

    import { useState, useEffect } from "react";
    import { useQuery, useMutation } from "convex/react";
    import { api } from "../../../../convex/_generated/api";
    import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
    import { Button } from "@/components/ui/button";
    import { Input } from "@/components/ui/input";
    import { Label } from "@/components/ui/label";
    import { Switch } from "@/components/ui/switch";
    import {
      Select,
      SelectContent,
      SelectItem,
      SelectTrigger,
      SelectValue,
    } from "@/components/ui/select";
    import { Plus, Trash2, GripVertical } from "lucide-react";

    interface PatientField {
      id: string;
      name: string;
      type: "text" | "number" | "date" | "select";
      required: boolean;
      options?: string[];
    }

    export function PatientFieldsForm() {
      const [isSaving, setIsSaving] = useState(false);
      const [success, setSuccess] = useState(false);
      const [fields, setFields] = useState<PatientField[]>([]);
      const [newOptionInput, setNewOptionInput] = useState<{ [key: string]: string }>({});

      const clinic = useQuery(api.clinics.getCurrentClinic);
      const updateClinic = useMutation(api.clinics.updateClinic);

      useEffect(() => {
        if (clinic?.patientFields) {
          setFields(clinic.patientFields as PatientField[]);
        }
      }, [clinic]);

      const addField = () => {
        const newField: PatientField = {
          id: crypto.randomUUID(),
          name: "",
          type: "text",
          required: false,
        };
        setFields([...fields, newField]);
      };

      const removeField = (id: string) => {
        setFields(fields.filter((f) => f.id !== id));
      };

      const updateField = (id: string, updates: Partial<PatientField>) => {
        setFields(
          fields.map((f) => (f.id === id ? { ...f, ...updates } : f))
        );
      };

      const addOption = (fieldId: string) => {
        const optionValue = newOptionInput[fieldId]?.trim();
        if (!optionValue) return;

        setFields(
          fields.map((f) => {
            if (f.id === fieldId) {
              return {
                ...f,
                options: [...(f.options || []), optionValue],
              };
            }
            return f;
          })
        );
        setNewOptionInput({ ...newOptionInput, [fieldId]: "" });
      };

      const removeOption = (fieldId: string, optionIndex: number) => {
        setFields(
          fields.map((f) => {
            if (f.id === fieldId && f.options) {
              return {
                ...f,
                options: f.options.filter((_, i) => i !== optionIndex),
              };
            }
            return f;
          })
        );
      };

      const handleSave = async () => {
        // Filter out fields without names
        const validFields = fields.filter((f) => f.name.trim());

        setIsSaving(true);
        setSuccess(false);
        try {
          await updateClinic({
            patientFields: validFields,
          });
          setSuccess(true);
          setTimeout(() => setSuccess(false), 3000);
        } catch (error) {
          console.error("Failed to save patient fields:", error);
        } finally {
          setIsSaving(false);
        }
      };

      return (
        <Card>
          <CardHeader>
            <CardTitle>Campos Personalizados de Paciente</CardTitle>
            <CardDescription>
              Define campos adicionales para la ficha de paciente
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            {fields.length === 0 && (
              <p className="text-sm text-muted-foreground py-4 text-center">
                No hay campos personalizados. Agrega uno para comenzar.
              </p>
            )}

            {fields.map((field, index) => (
              <div
                key={field.id}
                className="border rounded-lg p-4 space-y-3"
              >
                <div className="flex items-center gap-2">
                  <GripVertical className="h-4 w-4 text-muted-foreground cursor-move" />
                  <span className="text-sm text-muted-foreground">Campo {index + 1}</span>
                  <div className="flex-1" />
                  <Button
                    type="button"
                    variant="ghost"
                    size="icon"
                    onClick={() => removeField(field.id)}
                  >
                    <Trash2 className="h-4 w-4 text-red-500" />
                  </Button>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label>Nombre del campo</Label>
                    <Input
                      value={field.name}
                      onChange={(e) => updateField(field.id, { name: e.target.value })}
                      placeholder="Ej: Alergias"
                    />
                  </div>

                  <div className="space-y-2">
                    <Label>Tipo</Label>
                    <Select
                      value={field.type}
                      onValueChange={(value: PatientField["type"]) =>
                        updateField(field.id, { type: value })
                      }
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="text">Texto</SelectItem>
                        <SelectItem value="number">Numero</SelectItem>
                        <SelectItem value="date">Fecha</SelectItem>
                        <SelectItem value="select">Seleccion</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                </div>

                <div className="flex items-center space-x-2">
                  <Switch
                    id={`required-${field.id}`}
                    checked={field.required}
                    onCheckedChange={(checked) =>
                      updateField(field.id, { required: checked })
                    }
                  />
                  <Label htmlFor={`required-${field.id}`}>Campo obligatorio</Label>
                </div>

                {field.type === "select" && (
                  <div className="space-y-2 border-t pt-3">
                    <Label>Opciones</Label>
                    <div className="flex gap-2">
                      <Input
                        placeholder="Nueva opcion"
                        value={newOptionInput[field.id] || ""}
                        onChange={(e) =>
                          setNewOptionInput({
                            ...newOptionInput,
                            [field.id]: e.target.value,
                          })
                        }
                        onKeyDown={(e) => {
                          if (e.key === "Enter") {
                            e.preventDefault();
                            addOption(field.id);
                          }
                        }}
                      />
                      <Button
                        type="button"
                        variant="outline"
                        onClick={() => addOption(field.id)}
                      >
                        Agregar
                      </Button>
                    </div>
                    <div className="flex flex-wrap gap-2">
                      {field.options?.map((option, i) => (
                        <span
                          key={i}
                          className="inline-flex items-center gap-1 px-2 py-1 bg-muted rounded-md text-sm"
                        >
                          {option}
                          <button
                            type="button"
                            onClick={() => removeOption(field.id, i)}
                            className="text-muted-foreground hover:text-foreground"
                          >
                            x
                          </button>
                        </span>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            ))}

            <Button
              type="button"
              variant="outline"
              onClick={addField}
              className="w-full"
            >
              <Plus className="h-4 w-4 mr-2" />
              Agregar campo
            </Button>

            <div className="flex items-center gap-2 pt-4 border-t">
              <Button onClick={handleSave} disabled={isSaving}>
                {isSaving ? "Guardando..." : "Guardar campos"}
              </Button>
              {success && (
                <span className="text-sm text-green-600">Guardado correctamente</span>
              )}
            </div>
          </CardContent>
        </Card>
      );
    }
    ```

    2. Create src/components/settings/staff-invitation-form.tsx:
    ```typescript
    "use client";

    import { useState } from "react";
    import { useForm } from "react-hook-form";
    import { zodResolver } from "@hookform/resolvers/zod";
    import { z } from "zod";
    import { useMutation } from "convex/react";
    import { api } from "../../../../convex/_generated/api";
    import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
    import { Button } from "@/components/ui/button";
    import { Input } from "@/components/ui/input";
    import { Label } from "@/components/ui/label";
    import {
      Select,
      SelectContent,
      SelectItem,
      SelectTrigger,
      SelectValue,
    } from "@/components/ui/select";
    import { Copy, Check } from "lucide-react";

    const inviteSchema = z.object({
      email: z.string().email("Email invalido"),
      role: z.enum(["admin", "staff"]),
    });

    type InviteFormData = z.infer<typeof inviteSchema>;

    export function StaffInvitationForm() {
      const [isInviting, setIsInviting] = useState(false);
      const [inviteLink, setInviteLink] = useState<string | null>(null);
      const [copied, setCopied] = useState(false);
      const [error, setError] = useState<string | null>(null);

      const inviteStaff = useMutation(api.clinics.inviteStaff);

      const form = useForm<InviteFormData>({
        resolver: zodResolver(inviteSchema),
        defaultValues: {
          email: "",
          role: "staff",
        },
      });

      const onSubmit = async (data: InviteFormData) => {
        setIsInviting(true);
        setError(null);
        setInviteLink(null);

        try {
          const result = await inviteStaff({
            email: data.email,
            role: data.role,
          });

          // Generate invite link
          const link = `${window.location.origin}/invite?token=${result.token}`;
          setInviteLink(link);
          form.reset();
        } catch (err) {
          setError(err instanceof Error ? err.message : "Error al enviar invitacion");
        } finally {
          setIsInviting(false);
        }
      };

      const copyLink = async () => {
        if (inviteLink) {
          await navigator.clipboard.writeText(inviteLink);
          setCopied(true);
          setTimeout(() => setCopied(false), 2000);
        }
      };

      return (
        <Card>
          <CardHeader>
            <CardTitle>Invitar miembro del equipo</CardTitle>
            <CardDescription>
              Envia una invitacion por email para unirse a tu clinica
            </CardDescription>
          </CardHeader>
          <CardContent>
            <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
              {error && (
                <div className="p-3 text-sm text-red-500 bg-red-50 border border-red-200 rounded-md">
                  {error}
                </div>
              )}

              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="email">Email</Label>
                  <Input
                    id="email"
                    type="email"
                    placeholder="colega@email.com"
                    {...form.register("email")}
                  />
                  {form.formState.errors.email && (
                    <p className="text-sm text-red-500">
                      {form.formState.errors.email.message}
                    </p>
                  )}
                </div>

                <div className="space-y-2">
                  <Label>Rol</Label>
                  <Select
                    value={form.watch("role")}
                    onValueChange={(value: "admin" | "staff") =>
                      form.setValue("role", value)
                    }
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="staff">Staff</SelectItem>
                      <SelectItem value="admin">Administrador</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>

              <Button type="submit" disabled={isInviting}>
                {isInviting ? "Enviando..." : "Enviar invitacion"}
              </Button>

              {inviteLink && (
                <div className="p-4 bg-muted rounded-lg space-y-2">
                  <p className="text-sm font-medium">Link de invitacion generado:</p>
                  <div className="flex items-center gap-2">
                    <Input
                      value={inviteLink}
                      readOnly
                      className="bg-background text-sm"
                    />
                    <Button
                      type="button"
                      variant="outline"
                      size="icon"
                      onClick={copyLink}
                    >
                      {copied ? (
                        <Check className="h-4 w-4 text-green-500" />
                      ) : (
                        <Copy className="h-4 w-4" />
                      )}
                    </Button>
                  </div>
                  <p className="text-xs text-muted-foreground">
                    El link expira en 7 dias. Compartelo con tu colega.
                  </p>
                </div>
              )}
            </form>
          </CardContent>
        </Card>
      );
    }
    ```

    3. Create src/components/settings/staff-list.tsx:
    ```typescript
    "use client";

    import { useQuery } from "convex/react";
    import { api } from "../../../../convex/_generated/api";
    import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
    import { Avatar, AvatarFallback } from "@/components/ui/avatar";
    import { Badge } from "@/components/ui/badge";

    export function StaffList() {
      const staffList = useQuery(api.clinics.getClinicStaff);

      if (!staffList) {
        return (
          <Card>
            <CardContent className="py-8">
              <div className="flex justify-center">
                <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-primary" />
              </div>
            </CardContent>
          </Card>
        );
      }

      return (
        <Card>
          <CardHeader>
            <CardTitle>Miembros del equipo</CardTitle>
            <CardDescription>
              {staffList.length} {staffList.length === 1 ? "miembro" : "miembros"} en tu clinica
            </CardDescription>
          </CardHeader>
          <CardContent>
            {staffList.length === 0 ? (
              <p className="text-sm text-muted-foreground text-center py-4">
                No hay miembros del equipo todavia.
              </p>
            ) : (
              <div className="space-y-3">
                {staffList.map((member) => {
                  const initials = member.name
                    ?.split(" ")
                    .map((n) => n[0])
                    .join("")
                    .toUpperCase()
                    .slice(0, 2) || "??";

                  return (
                    <div
                      key={member.id}
                      className="flex items-center justify-between p-3 rounded-lg border"
                    >
                      <div className="flex items-center gap-3">
                        <Avatar>
                          <AvatarFallback>{initials}</AvatarFallback>
                        </Avatar>
                        <div>
                          <p className="font-medium">{member.name || "Sin nombre"}</p>
                          <p className="text-sm text-muted-foreground">{member.email}</p>
                        </div>
                      </div>
                      <Badge variant={member.role === "admin" ? "default" : "secondary"}>
                        {member.role === "admin" ? "Admin" : "Staff"}
                      </Badge>
                    </div>
                  );
                })}
              </div>
            )}
          </CardContent>
        </Card>
      );
    }
    ```

    4. Install badge component:
    ```bash
    npx shadcn@latest add badge
    ```

    5. Create src/app/(dashboard)/dashboard/team/page.tsx:
    ```typescript
    import { StaffInvitationForm } from "@/components/settings/staff-invitation-form";
    import { StaffList } from "@/components/settings/staff-list";

    export default function TeamPage() {
      return (
        <div className="space-y-6">
          <div>
            <h1 className="text-3xl font-bold tracking-tight">Equipo</h1>
            <p className="text-muted-foreground">
              Gestiona los miembros de tu clinica
            </p>
          </div>

          <div className="grid gap-6 md:grid-cols-2">
            <StaffInvitationForm />
            <StaffList />
          </div>
        </div>
      );
    }
    ```

    6. Create src/app/(dashboard)/dashboard/team/layout.tsx (admin protection):
    ```typescript
    "use client";

    import { useAuth } from "@/hooks/use-auth";
    import { useRouter } from "next/navigation";
    import { useEffect } from "react";

    export default function TeamLayout({
      children,
    }: {
      children: React.ReactNode;
    }) {
      const { user, isLoading } = useAuth();
      const router = useRouter();

      useEffect(() => {
        if (!isLoading && user && user.role !== "admin") {
          router.push("/dashboard");
        }
      }, [isLoading, user, router]);

      if (isLoading || user?.role !== "admin") {
        return null;
      }

      return <>{children}</>;
    }
    ```
  </action>
  <verify>
    - Patient fields can be added, configured, and saved
    - /dashboard/team shows staff list and invitation form
    - Invitation generates shareable link
    - Staff list shows all clinic members with roles
  </verify>
  <done>
    Custom patient fields configuration and staff management (invitations + list) complete
  </done>
</task>

</tasks>

<verification>
1. Visit /dashboard/settings - see all 4 tabs
2. Edit clinic name/phone - saves successfully
3. Configure bot - toggle, message, language all work
4. Configure time - timezone, hours, duration save
5. Add custom patient field - test all types (text, number, date, select)
6. Visit /dashboard/team - see invitation form and staff list
7. Create invitation - get shareable link
8. Staff user cannot access /dashboard/settings or /dashboard/team
</verification>

<success_criteria>
- Settings page accessible only by admins
- General settings form saves clinic name and phone
- Bot configuration form toggles enabled, saves message and language
- Time configuration saves timezone, working hours, appointment duration, buffer
- Custom patient fields can be added with name, type, required flag
- Select-type fields support multiple options
- Staff invitation generates token-based link
- Staff list shows all members with role badges
- Non-admin users redirected from settings and team pages
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-05-SUMMARY.md`
</output>
