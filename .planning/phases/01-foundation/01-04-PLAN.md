---
phase: 01-foundation
plan: 04
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/app/(dashboard)/layout.tsx
  - src/app/(dashboard)/dashboard/page.tsx
  - src/components/layout/sidebar.tsx
  - src/components/layout/header.tsx
  - src/components/layout/nav-item.tsx
  - src/components/layout/user-menu.tsx
  - middleware.ts
autonomous: true

must_haves:
  truths:
    - "Unauthenticated user redirected from /dashboard to /login"
    - "Authenticated user sees sidebar with navigation"
    - "Sidebar shows different items based on user role"
    - "User can see their name and clinic in header"
    - "User can logout from user menu"
  artifacts:
    - path: "src/app/(dashboard)/layout.tsx"
      provides: "Dashboard layout with sidebar"
      min_lines: 30
    - path: "src/components/layout/sidebar.tsx"
      provides: "Navigation sidebar"
      contains: "nav"
    - path: "middleware.ts"
      provides: "Route protection middleware"
      contains: "middleware"
  key_links:
    - from: "middleware.ts"
      to: "/login"
      via: "redirect for unauthenticated"
      pattern: "redirect.*login"
    - from: "src/components/layout/sidebar.tsx"
      to: "user role"
      via: "conditional rendering"
      pattern: "role.*admin"
---

<objective>
Build the dashboard layout with sidebar navigation, header with user info, and protected route middleware for role-based access control.

Purpose: Establish the application shell that all dashboard features will live within.
Output: Working dashboard layout with sidebar, header, and route protection.
</objective>

<context>
@.planning/phases/01-foundation/01-01-SUMMARY.md (for project structure)

Dependencies:
- shadcn/ui components from Plan 01
- User/clinic data from Convex (Plan 02)

Navigation structure:
- Dashboard (home) - all roles
- Pacientes - all roles
- Citas - all roles
- Configuracion (Settings) - admin only
- Equipo (Staff) - admin only

Layout:
- Fixed sidebar on left (collapsible on mobile)
- Header with clinic name + user menu
- Main content area
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Next.js middleware for route protection</name>
  <files>
    middleware.ts
    src/lib/auth-config.ts
  </files>
  <action>
    1. Create src/lib/auth-config.ts with route definitions:
    ```typescript
    // Routes that don't require authentication
    export const publicRoutes = [
      "/",
      "/login",
      "/register",
      "/forgot-password",
      "/reset-password",
      "/verify-email",
      "/invite",
    ];

    // Routes that require admin role
    export const adminRoutes = [
      "/dashboard/settings",
      "/dashboard/team",
    ];

    // Default redirect after login
    export const DEFAULT_LOGIN_REDIRECT = "/dashboard";

    // Check if route is public
    export function isPublicRoute(pathname: string): boolean {
      return publicRoutes.some(route =>
        pathname === route || pathname.startsWith(`${route}/`)
      );
    }

    // Check if route requires admin
    export function isAdminRoute(pathname: string): boolean {
      return adminRoutes.some(route =>
        pathname === route || pathname.startsWith(`${route}/`)
      );
    }
    ```

    2. Create middleware.ts at project root:
    ```typescript
    import { NextResponse } from "next/server";
    import type { NextRequest } from "next/server";
    import {
      isPublicRoute,
      isAdminRoute,
      DEFAULT_LOGIN_REDIRECT
    } from "@/lib/auth-config";

    export function middleware(request: NextRequest) {
      const { pathname } = request.nextUrl;

      // Allow public routes
      if (isPublicRoute(pathname)) {
        return NextResponse.next();
      }

      // Check for auth token (Convex stores in cookie)
      // Note: Full auth check happens on client side with Convex
      // Middleware provides basic protection and redirect
      const hasAuthToken = request.cookies.has("__convexAuthToken");

      if (!hasAuthToken) {
        const loginUrl = new URL("/login", request.url);
        loginUrl.searchParams.set("callbackUrl", pathname);
        return NextResponse.redirect(loginUrl);
      }

      // For admin routes, we'll check role on the client side
      // Middleware can't easily access Convex data
      // The actual role check happens in the layout/page component

      return NextResponse.next();
    }

    export const config = {
      matcher: [
        /*
         * Match all request paths except:
         * - _next/static (static files)
         * - _next/image (image optimization files)
         * - favicon.ico (favicon file)
         * - public folder
         * - api routes (handled separately)
         */
        "/((?!_next/static|_next/image|favicon.ico|public|api).*)",
      ],
    };
    ```
  </action>
  <verify>
    - Visiting /dashboard without auth redirects to /login
    - /login, /register accessible without auth
    - Middleware doesn't block static assets
  </verify>
  <done>
    Route protection middleware implemented with public/protected route handling
  </done>
</task>

<task type="auto">
  <name>Task 2: Build sidebar and navigation components</name>
  <files>
    src/components/layout/sidebar.tsx
    src/components/layout/nav-item.tsx
    src/components/layout/mobile-nav.tsx
  </files>
  <action>
    1. Install additional shadcn components:
    ```bash
    npx shadcn@latest add sheet separator avatar dropdown-menu
    ```

    2. Create src/components/layout/nav-item.tsx:
    ```typescript
    "use client";

    import Link from "next/link";
    import { usePathname } from "next/navigation";
    import { cn } from "@/lib/utils";
    import { LucideIcon } from "lucide-react";

    interface NavItemProps {
      href: string;
      icon: LucideIcon;
      label: string;
      adminOnly?: boolean;
      isAdmin?: boolean;
    }

    export function NavItem({ href, icon: Icon, label, adminOnly, isAdmin }: NavItemProps) {
      const pathname = usePathname();
      const isActive = pathname === href || pathname.startsWith(`${href}/`);

      // Hide admin-only items from non-admins
      if (adminOnly && !isAdmin) {
        return null;
      }

      return (
        <Link
          href={href}
          className={cn(
            "flex items-center gap-3 rounded-lg px-3 py-2 text-sm transition-colors",
            isActive
              ? "bg-primary text-primary-foreground"
              : "text-muted-foreground hover:bg-muted hover:text-foreground"
          )}
        >
          <Icon className="h-4 w-4" />
          {label}
        </Link>
      );
    }
    ```

    3. Create src/components/layout/sidebar.tsx:
    ```typescript
    "use client";

    import { useAuth } from "@/hooks/use-auth";
    import { NavItem } from "./nav-item";
    import { Separator } from "@/components/ui/separator";
    import {
      LayoutDashboard,
      Users,
      Calendar,
      Settings,
      UserPlus,
    } from "lucide-react";

    const navItems = [
      {
        href: "/dashboard",
        icon: LayoutDashboard,
        label: "Dashboard",
      },
      {
        href: "/dashboard/patients",
        icon: Users,
        label: "Pacientes",
      },
      {
        href: "/dashboard/appointments",
        icon: Calendar,
        label: "Citas",
      },
    ];

    const adminItems = [
      {
        href: "/dashboard/settings",
        icon: Settings,
        label: "Configuracion",
        adminOnly: true,
      },
      {
        href: "/dashboard/team",
        icon: UserPlus,
        label: "Equipo",
        adminOnly: true,
      },
    ];

    export function Sidebar() {
      const { user } = useAuth();
      const isAdmin = user?.role === "admin";

      return (
        <aside className="hidden lg:flex h-screen w-64 flex-col border-r bg-background">
          {/* Logo/Brand */}
          <div className="flex h-16 items-center border-b px-6">
            <span className="text-lg font-semibold">
              {user?.clinic?.name || "Dental Clinic"}
            </span>
          </div>

          {/* Navigation */}
          <nav className="flex-1 space-y-1 p-4">
            {navItems.map((item) => (
              <NavItem
                key={item.href}
                href={item.href}
                icon={item.icon}
                label={item.label}
              />
            ))}

            {isAdmin && (
              <>
                <Separator className="my-4" />
                <p className="px-3 text-xs font-medium text-muted-foreground uppercase tracking-wider mb-2">
                  Administracion
                </p>
                {adminItems.map((item) => (
                  <NavItem
                    key={item.href}
                    href={item.href}
                    icon={item.icon}
                    label={item.label}
                    adminOnly={item.adminOnly}
                    isAdmin={isAdmin}
                  />
                ))}
              </>
            )}
          </nav>

          {/* Footer */}
          <div className="border-t p-4">
            <p className="text-xs text-muted-foreground">
              {user?.role === "admin" ? "Administrador" : "Staff"}
            </p>
          </div>
        </aside>
      );
    }
    ```

    4. Create src/components/layout/mobile-nav.tsx:
    ```typescript
    "use client";

    import { useState } from "react";
    import { useAuth } from "@/hooks/use-auth";
    import { NavItem } from "./nav-item";
    import { Button } from "@/components/ui/button";
    import {
      Sheet,
      SheetContent,
      SheetHeader,
      SheetTitle,
      SheetTrigger,
    } from "@/components/ui/sheet";
    import { Separator } from "@/components/ui/separator";
    import {
      Menu,
      LayoutDashboard,
      Users,
      Calendar,
      Settings,
      UserPlus,
    } from "lucide-react";

    const navItems = [
      { href: "/dashboard", icon: LayoutDashboard, label: "Dashboard" },
      { href: "/dashboard/patients", icon: Users, label: "Pacientes" },
      { href: "/dashboard/appointments", icon: Calendar, label: "Citas" },
    ];

    const adminItems = [
      { href: "/dashboard/settings", icon: Settings, label: "Configuracion", adminOnly: true },
      { href: "/dashboard/team", icon: UserPlus, label: "Equipo", adminOnly: true },
    ];

    export function MobileNav() {
      const [open, setOpen] = useState(false);
      const { user } = useAuth();
      const isAdmin = user?.role === "admin";

      return (
        <Sheet open={open} onOpenChange={setOpen}>
          <SheetTrigger asChild>
            <Button variant="ghost" size="icon" className="lg:hidden">
              <Menu className="h-5 w-5" />
              <span className="sr-only">Toggle menu</span>
            </Button>
          </SheetTrigger>
          <SheetContent side="left" className="w-64 p-0">
            <SheetHeader className="border-b px-6 py-4">
              <SheetTitle>{user?.clinic?.name || "Dental Clinic"}</SheetTitle>
            </SheetHeader>
            <nav className="flex-1 space-y-1 p-4">
              {navItems.map((item) => (
                <div key={item.href} onClick={() => setOpen(false)}>
                  <NavItem
                    href={item.href}
                    icon={item.icon}
                    label={item.label}
                  />
                </div>
              ))}

              {isAdmin && (
                <>
                  <Separator className="my-4" />
                  <p className="px-3 text-xs font-medium text-muted-foreground uppercase tracking-wider mb-2">
                    Administracion
                  </p>
                  {adminItems.map((item) => (
                    <div key={item.href} onClick={() => setOpen(false)}>
                      <NavItem
                        href={item.href}
                        icon={item.icon}
                        label={item.label}
                        adminOnly={item.adminOnly}
                        isAdmin={isAdmin}
                      />
                    </div>
                  ))}
                </>
              )}
            </nav>
          </SheetContent>
        </Sheet>
      );
    }
    ```
  </action>
  <verify>
    - Sidebar renders with navigation items
    - Admin-only items hidden for non-admins
    - Mobile nav opens/closes correctly
  </verify>
  <done>
    Sidebar with role-based navigation and mobile responsive drawer implemented
  </done>
</task>

<task type="auto">
  <name>Task 3: Build header and dashboard layout</name>
  <files>
    src/components/layout/header.tsx
    src/components/layout/user-menu.tsx
    src/app/(dashboard)/layout.tsx
    src/app/(dashboard)/dashboard/page.tsx
  </files>
  <action>
    1. Create src/components/layout/user-menu.tsx:
    ```typescript
    "use client";

    import { useAuth } from "@/hooks/use-auth";
    import {
      DropdownMenu,
      DropdownMenuContent,
      DropdownMenuItem,
      DropdownMenuLabel,
      DropdownMenuSeparator,
      DropdownMenuTrigger,
    } from "@/components/ui/dropdown-menu";
    import { Avatar, AvatarFallback } from "@/components/ui/avatar";
    import { Button } from "@/components/ui/button";
    import { LogOut, Settings, User } from "lucide-react";
    import Link from "next/link";

    export function UserMenu() {
      const { user, logout } = useAuth();

      const initials = user?.name
        ?.split(" ")
        .map((n) => n[0])
        .join("")
        .toUpperCase()
        .slice(0, 2) || "??";

      return (
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="ghost" className="relative h-10 w-10 rounded-full">
              <Avatar className="h-10 w-10">
                <AvatarFallback className="bg-primary text-primary-foreground">
                  {initials}
                </AvatarFallback>
              </Avatar>
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent className="w-56" align="end" forceMount>
            <DropdownMenuLabel className="font-normal">
              <div className="flex flex-col space-y-1">
                <p className="text-sm font-medium leading-none">{user?.name}</p>
                <p className="text-xs leading-none text-muted-foreground">
                  {user?.email}
                </p>
              </div>
            </DropdownMenuLabel>
            <DropdownMenuSeparator />
            <DropdownMenuItem asChild>
              <Link href="/dashboard/profile" className="cursor-pointer">
                <User className="mr-2 h-4 w-4" />
                Mi Perfil
              </Link>
            </DropdownMenuItem>
            {user?.role === "admin" && (
              <DropdownMenuItem asChild>
                <Link href="/dashboard/settings" className="cursor-pointer">
                  <Settings className="mr-2 h-4 w-4" />
                  Configuracion
                </Link>
              </DropdownMenuItem>
            )}
            <DropdownMenuSeparator />
            <DropdownMenuItem
              className="cursor-pointer text-red-600 focus:text-red-600"
              onClick={() => logout()}
            >
              <LogOut className="mr-2 h-4 w-4" />
              Cerrar sesion
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      );
    }
    ```

    2. Create src/components/layout/header.tsx:
    ```typescript
    "use client";

    import { useAuth } from "@/hooks/use-auth";
    import { MobileNav } from "./mobile-nav";
    import { UserMenu } from "./user-menu";
    import { Bell } from "lucide-react";
    import { Button } from "@/components/ui/button";

    export function Header() {
      const { user } = useAuth();

      return (
        <header className="sticky top-0 z-40 border-b bg-background">
          <div className="flex h-16 items-center gap-4 px-4 md:px-6">
            {/* Mobile menu trigger */}
            <MobileNav />

            {/* Spacer */}
            <div className="flex-1" />

            {/* Clinic name on mobile */}
            <div className="lg:hidden text-sm font-medium truncate max-w-[150px]">
              {user?.clinic?.name}
            </div>

            {/* Spacer on mobile */}
            <div className="flex-1 lg:hidden" />

            {/* Right side actions */}
            <div className="flex items-center gap-2">
              {/* Notifications placeholder */}
              <Button variant="ghost" size="icon" className="relative">
                <Bell className="h-5 w-5" />
                <span className="sr-only">Notificaciones</span>
              </Button>

              {/* User menu */}
              <UserMenu />
            </div>
          </div>
        </header>
      );
    }
    ```

    3. Update src/app/(dashboard)/layout.tsx:
    ```typescript
    "use client";

    import { useAuth } from "@/hooks/use-auth";
    import { Sidebar } from "@/components/layout/sidebar";
    import { Header } from "@/components/layout/header";
    import { useRouter } from "next/navigation";
    import { useEffect } from "react";

    export default function DashboardLayout({
      children,
    }: {
      children: React.ReactNode;
    }) {
      const { user, isLoading, isAuthenticated } = useAuth();
      const router = useRouter();

      useEffect(() => {
        // Redirect to login if not authenticated
        if (!isLoading && !isAuthenticated) {
          router.push("/login");
        }

        // Redirect to verify email if not verified
        if (user && !user.emailVerified) {
          router.push("/verify-email");
        }
      }, [isLoading, isAuthenticated, user, router]);

      // Show loading state
      if (isLoading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary" />
          </div>
        );
      }

      // Don't render dashboard until authenticated
      if (!isAuthenticated) {
        return null;
      }

      return (
        <div className="min-h-screen flex">
          {/* Sidebar - hidden on mobile */}
          <Sidebar />

          {/* Main content */}
          <div className="flex-1 flex flex-col">
            <Header />
            <main className="flex-1 p-4 md:p-6 lg:p-8">
              {children}
            </main>
          </div>
        </div>
      );
    }
    ```

    4. Create src/app/(dashboard)/dashboard/page.tsx:
    ```typescript
    "use client";

    import { useAuth } from "@/hooks/use-auth";
    import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
    import { Users, Calendar, Clock, TrendingUp } from "lucide-react";

    export default function DashboardPage() {
      const { user } = useAuth();

      return (
        <div className="space-y-6">
          {/* Welcome header */}
          <div>
            <h1 className="text-3xl font-bold tracking-tight">
              Hola, {user?.name?.split(" ")[0] || "Usuario"}
            </h1>
            <p className="text-muted-foreground">
              Bienvenido al dashboard de {user?.clinic?.name}
            </p>
          </div>

          {/* Stats cards */}
          <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-sm font-medium">
                  Pacientes Totales
                </CardTitle>
                <Users className="h-4 w-4 text-muted-foreground" />
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold">0</div>
                <p className="text-xs text-muted-foreground">
                  Registra tu primer paciente
                </p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-sm font-medium">
                  Citas Hoy
                </CardTitle>
                <Calendar className="h-4 w-4 text-muted-foreground" />
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold">0</div>
                <p className="text-xs text-muted-foreground">
                  Sin citas programadas
                </p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-sm font-medium">
                  Esta Semana
                </CardTitle>
                <Clock className="h-4 w-4 text-muted-foreground" />
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold">0</div>
                <p className="text-xs text-muted-foreground">
                  Citas en los proximos 7 dias
                </p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-sm font-medium">
                  Crecimiento
                </CardTitle>
                <TrendingUp className="h-4 w-4 text-muted-foreground" />
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold">-</div>
                <p className="text-xs text-muted-foreground">
                  vs mes anterior
                </p>
              </CardContent>
            </Card>
          </div>

          {/* Quick actions or recent activity */}
          <div className="grid gap-4 md:grid-cols-2">
            <Card>
              <CardHeader>
                <CardTitle>Proximas Citas</CardTitle>
                <CardDescription>
                  Citas programadas para hoy
                </CardDescription>
              </CardHeader>
              <CardContent>
                <p className="text-sm text-muted-foreground">
                  No hay citas programadas para hoy.
                </p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle>Actividad Reciente</CardTitle>
                <CardDescription>
                  Ultimas acciones en el sistema
                </CardDescription>
              </CardHeader>
              <CardContent>
                <p className="text-sm text-muted-foreground">
                  Bienvenido! Empieza agregando pacientes.
                </p>
              </CardContent>
            </Card>
          </div>
        </div>
      );
    }
    ```
  </action>
  <verify>
    - npm run dev starts without errors
    - /dashboard shows sidebar + header + content
    - User menu shows name, email, logout option
    - Logout redirects to /login
    - Mobile view shows hamburger menu
  </verify>
  <done>
    Dashboard layout with header, sidebar, user menu, and home page complete
  </done>
</task>

</tasks>

<verification>
1. Visit /dashboard without auth - redirected to /login
2. Login and visit /dashboard - see sidebar, header, stats cards
3. Check sidebar shows admin items only for admin users
4. Open user menu dropdown - see profile, settings, logout
5. Click logout - redirected to /login
6. On mobile viewport - sidebar hidden, hamburger menu works
</verification>

<success_criteria>
- Middleware redirects unauthenticated users to /login
- Dashboard layout with fixed sidebar and sticky header
- Sidebar shows navigation items based on user role
- User menu with avatar, name, email, and logout
- Mobile responsive with sheet/drawer navigation
- Dashboard home page with placeholder stats cards
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md`
</output>
