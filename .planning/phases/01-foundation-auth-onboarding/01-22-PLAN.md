---
phase: 01-foundation-auth-onboarding
plan: 22
type: execute
wave: 11
depends_on: ["01-17", "01-18", "01-19", "01-20", "01-21"]
files_modified: [src/app/onboarding/layout.tsx, src/app/onboarding/page.tsx, convex/clinics.ts]
autonomous: true
must_haves:
  truths:
    - "/onboarding shows wizard"
    - "completeOnboarding mutation saves all data"
  artifacts:
    - path: "src/app/onboarding/page.tsx"
      min_lines: 60
---

<objective>
Create onboarding page and completeOnboarding mutation.

Purpose: Container for wizard steps and completion logic.
Output: Working onboarding wizard at /onboarding.
</objective>

<tasks>

<task type="auto">
  <name>Create onboarding page and mutation</name>
  <files>src/app/onboarding/layout.tsx, src/app/onboarding/page.tsx, convex/clinics.ts</files>
  <action>
  1. Create src/app/onboarding/layout.tsx:
  ```typescript
  export default function OnboardingLayout({
    children,
  }: {
    children: React.ReactNode;
  }) {
    return (
      <div className="min-h-screen bg-gray-50 py-8 px-4">
        <div className="max-w-lg mx-auto">
          <div className="text-center mb-8">
            <h1 className="text-2xl font-bold text-gray-900">ConsultSystem</h1>
            <p className="text-gray-600">Configuraci√≥n inicial</p>
          </div>
          {children}
        </div>
      </div>
    );
  }
  ```

  2. Create src/app/onboarding/page.tsx:
  ```typescript
  "use client";

  import { useOnboardingStore } from "@/lib/stores/onboarding-store";
  import { ProgressBar } from "@/components/onboarding/progress-bar";
  import { Step1Account } from "@/components/onboarding/step-1-account";
  import { Step2Clinic } from "@/components/onboarding/step-2-clinic";
  import { Step3Branding } from "@/components/onboarding/step-3-branding";
  import { Step4Schedule } from "@/components/onboarding/step-4-schedule";
  import { Step5Setup } from "@/components/onboarding/step-5-setup";

  export default function OnboardingPage() {
    const { currentStep, setStep } = useOnboardingStore();

    const handleNext = () => setStep(currentStep + 1);
    const handleBack = () => setStep(currentStep - 1);

    return (
      <div>
        <ProgressBar currentStep={currentStep} />

        {currentStep === 1 && <Step1Account onNext={handleNext} />}
        {currentStep === 2 && <Step2Clinic onNext={handleNext} onBack={handleBack} />}
        {currentStep === 3 && <Step3Branding onNext={handleNext} onBack={handleBack} />}
        {currentStep === 4 && <Step4Schedule onNext={handleNext} onBack={handleBack} />}
        {currentStep === 5 && <Step5Setup onBack={handleBack} />}
      </div>
    );
  }
  ```

  3. Add completeOnboarding mutation to convex/clinics.ts:
  ```typescript
  export const completeOnboarding = mutation({
    args: {
      clinic: v.object({
        name: v.string(),
        taxId: v.string(),
        address: v.string(),
        phone: v.string(),
      }),
      branding: v.object({
        logo: v.optional(v.string()),
        primaryColor: v.string(),
        secondaryColor: v.string(),
      }),
      schedule: v.object({
        workDays: v.array(v.number()),
        openTime: v.string(),
        closeTime: v.string(),
        lunchStart: v.optional(v.string()),
        lunchEnd: v.optional(v.string()),
      }),
      setup: v.object({
        professionalName: v.string(),
        serviceName: v.string(),
        serviceDuration: v.number(),
      }),
    },
    handler: async (ctx, args) => {
      const identity = await ctx.auth.getUserIdentity();
      if (!identity) throw new Error("No autenticado");

      const user = await ctx.db
        .query("users")
        .withIndex("by_email", (q) => q.eq("email", identity.email!))
        .first();

      if (!user) throw new Error("Usuario no encontrado");

      // Update clinic
      await ctx.db.patch(user.clinicId, {
        name: args.clinic.name,
        taxId: args.clinic.taxId,
        address: args.clinic.address,
        phone: args.clinic.phone,
        logo: args.branding.logo ? (args.branding.logo as any) : undefined,
        colors: {
          primary: args.branding.primaryColor,
          secondary: args.branding.secondaryColor,
        },
        hours: {
          open: args.schedule.openTime,
          close: args.schedule.closeTime,
          lunch: args.schedule.lunchStart ? {
            start: args.schedule.lunchStart,
            end: args.schedule.lunchEnd || "",
          } : undefined,
        },
        workDays: args.schedule.workDays,
        onboardingCompleted: true,
        updatedAt: Date.now(),
      });

      // Note: Professional and Service creation will be added in Phase 2
      // For now, just store the setup data in notes

      return { success: true };
    },
  });
  ```
  </action>
  <verify>/onboarding shows wizard with all steps</verify>
  <done>Onboarding page and mutation ready</done>
</task>

</tasks>

<verification>
- [ ] /onboarding renders wizard
- [ ] Steps navigate correctly
- [ ] Completion saves to database
</verification>

<success_criteria>
- Full wizard working
- Mutation saves data
- Redirects to dashboard
</success_criteria>

<output>
Create `.planning/phases/01-foundation-auth-onboarding/01-22-SUMMARY.md`
</output>
