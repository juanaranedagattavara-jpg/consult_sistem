---
phase: 01-foundation-auth-onboarding
plan: 27
type: execute
wave: 12
depends_on: ["01-10", "01-11"]
files_modified: [src/components/settings/profile-form.tsx]
autonomous: true
must_haves:
  truths:
    - "Profile form updates user data"
  artifacts:
    - path: "src/components/settings/profile-form.tsx"
      min_lines: 70
---

<objective>
Create user profile settings form component.

Purpose: Update user name and avatar.
Output: Profile form with avatar upload.
</objective>

<tasks>

<task type="auto">
  <name>Create profile form</name>
  <files>src/components/settings/profile-form.tsx</files>
  <action>
  Create src/components/settings/profile-form.tsx:

  ```typescript
  "use client";

  import { useForm } from "react-hook-form";
  import { useMutation, useQuery } from "convex/react";
  import { api } from "../../../convex/_generated/api";
  import { FileUpload } from "@/components/ui/file-upload";
  import { useFileUrl } from "@/hooks/use-file-url";
  import { Button } from "@/components/ui/button";
  import { Input } from "@/components/ui/input";
  import { Label } from "@/components/ui/label";
  import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
  import { toast } from "sonner";
  import { User } from "lucide-react";

  interface ProfileData {
    name: string;
    avatar: string | null;
  }

  export function ProfileForm() {
    const user = useQuery(api.users.getCurrentUser);
    const updateProfile = useMutation(api.users.updateProfile);
    const avatarUrl = useFileUrl(user?.avatar);

    const form = useForm<ProfileData>({
      defaultValues: {
        name: user?.name || "",
        avatar: user?.avatar || null,
      },
    });

    const onSubmit = async (data: ProfileData) => {
      try {
        await updateProfile({
          name: data.name,
          avatar: data.avatar ? (data.avatar as any) : undefined,
        });
        toast.success("Perfil actualizado");
      } catch (error: any) {
        toast.error(error.message || "Error al guardar");
      }
    };

    const handleAvatarUpload = (storageId: string) => {
      form.setValue("avatar", storageId);
    };

    if (!user) return <div>Cargando...</div>;

    return (
      <Card>
        <CardHeader>
          <CardTitle>Mi perfil</CardTitle>
        </CardHeader>
        <CardContent>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
            <div className="flex items-start gap-6">
              <div className="flex-shrink-0">
                {avatarUrl ? (
                  <img
                    src={avatarUrl}
                    alt="Avatar"
                    className="w-24 h-24 rounded-full object-cover"
                  />
                ) : (
                  <div className="w-24 h-24 rounded-full bg-gray-200 flex items-center justify-center">
                    <User className="w-12 h-12 text-gray-400" />
                  </div>
                )}
              </div>
              <div className="flex-1">
                <Label>Foto de perfil</Label>
                <FileUpload
                  onUpload={handleAvatarUpload}
                  className="mt-2"
                />
              </div>
            </div>

            <div>
              <Label htmlFor="name">Nombre</Label>
              <Input {...form.register("name")} id="name" className="mt-2" />
            </div>

            <div>
              <Label htmlFor="email">Email</Label>
              <Input
                value={user.email}
                id="email"
                disabled
                className="mt-2 bg-gray-50"
              />
              <p className="text-sm text-gray-500 mt-1">
                El email no se puede cambiar
              </p>
            </div>

            <div>
              <Label>Rol</Label>
              <Input
                value={user.role === "admin" ? "Administrador" : "Staff"}
                disabled
                className="mt-2 bg-gray-50"
              />
            </div>

            <Button type="submit" disabled={form.formState.isSubmitting}>
              {form.formState.isSubmitting ? "Guardando..." : "Guardar"}
            </Button>
          </form>
        </CardContent>
      </Card>
    );
  }
  ```
  </action>
  <verify>Form renders with avatar and name</verify>
  <done>Profile form ready</done>
</task>

</tasks>

<verification>
- [ ] Avatar upload works
- [ ] Name updates correctly
- [ ] Email shown but disabled
</verification>

<success_criteria>
- Profile form functional
- Avatar upload works
- Data persists
</success_criteria>

<output>
Create `.planning/phases/01-foundation-auth-onboarding/01-27-SUMMARY.md`
</output>
