---
phase: 01-foundation-auth-onboarding
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified: [convex/schema.ts]
autonomous: true
must_haves:
  truths:
    - "Schema deployed to Convex"
  artifacts:
    - path: "convex/schema.ts"
      contains: "clinics"
      exports: ["default"]
---

<objective>
Create Convex database schema with clinics and users tables.

Purpose: Define data structure for the entire application.
Output: Schema deployed with all required tables and indexes.
</objective>

<tasks>

<task type="auto">
  <name>Create Convex schema</name>
  <files>convex/schema.ts</files>
  <action>
  Create convex/schema.ts:

  ```typescript
  import { defineSchema, defineTable } from "convex/server";
  import { v } from "convex/values";

  export default defineSchema({
    clinics: defineTable({
      name: v.string(),
      slug: v.string(),
      taxId: v.string(),
      address: v.string(),
      phone: v.string(),
      email: v.string(),
      timezone: v.string(),
      logo: v.optional(v.id("_storage")),
      colors: v.object({
        primary: v.string(),
        secondary: v.string(),
      }),
      hours: v.object({
        open: v.string(),
        close: v.string(),
        lunch: v.optional(v.object({
          start: v.string(),
          end: v.string(),
        })),
      }),
      workDays: v.array(v.number()),
      defaultSlotDuration: v.number(),
      botConfig: v.object({
        tone: v.union(v.literal("formal"), v.literal("casual"), v.literal("amigable")),
        customPrompts: v.string(),
        faqs: v.array(v.object({
          question: v.string(),
          answer: v.string(),
        })),
        welcomeMessage: v.string(),
        afterHoursMessage: v.string(),
      }),
      timing: v.object({
        confirmationHours: v.number(),
        reminderHours: v.number(),
        retries: v.number(),
        waitlistTimeout: v.number(),
      }),
      waitlistConfig: v.object({
        priorityWeights: v.object({
          urgency: v.number(),
          patientHistory: v.number(),
          waitTime: v.number(),
          fifo: v.number(),
        }),
        notificationMethod: v.union(v.literal("sequential"), v.literal("broadcast")),
        broadcastLimit: v.number(),
        responseTimeout: v.number(),
        urgentTimeout: v.number(),
        onReject: v.union(v.literal("remove"), v.literal("keep"), v.literal("ask")),
      }),
      customPatientFields: v.array(v.object({
        name: v.string(),
        type: v.union(
          v.literal("text"),
          v.literal("number"),
          v.literal("date"),
          v.literal("select"),
          v.literal("checkbox")
        ),
        required: v.boolean(),
        options: v.optional(v.array(v.string())),
      })),
      onboardingCompleted: v.boolean(),
      active: v.boolean(),
      createdAt: v.number(),
      updatedAt: v.number(),
    })
      .index("by_slug", ["slug"])
      .index("by_email", ["email"]),

    users: defineTable({
      email: v.string(),
      passwordHash: v.string(),
      name: v.string(),
      role: v.union(v.literal("admin"), v.literal("staff")),
      clinicId: v.id("clinics"),
      avatar: v.optional(v.id("_storage")),
      active: v.boolean(),
      lastLogin: v.optional(v.number()),
      createdAt: v.number(),
    })
      .index("by_email", ["email"])
      .index("by_clinic", ["clinicId"]),
  });
  ```

  Run npx convex dev to deploy schema.
  </action>
  <verify>npx convex dev shows schema synced</verify>
  <done>Schema deployed with clinics and users tables</done>
</task>

</tasks>

<verification>
- [ ] convex/schema.ts exists
- [ ] Schema has clinics table with all fields
- [ ] Schema has users table with all fields
- [ ] Indexes created
</verification>

<success_criteria>
- Schema deployed to Convex
- All tables and indexes created
</success_criteria>

<output>
Create `.planning/phases/01-foundation-auth-onboarding/01-03-SUMMARY.md`
</output>
