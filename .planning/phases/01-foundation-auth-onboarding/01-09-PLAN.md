---
phase: 01-foundation-auth-onboarding
plan: 09
type: execute
wave: 5
depends_on: ["01-03"]
files_modified: [convex/clinics.ts]
autonomous: true
must_haves:
  truths:
    - "Settings mutations exist for clinic updates"
  artifacts:
    - path: "convex/clinics.ts"
      exports: ["updateClinicGeneral", "updateClinicBot", "updateClinicTiming", "updateClinicAppearance"]
---

<objective>
Create Convex mutations for clinic settings updates.

Purpose: Enable clinic configuration changes from settings pages.
Output: All settings-related mutations deployed.
</objective>

<tasks>

<task type="auto">
  <name>Create settings mutations</name>
  <files>convex/clinics.ts</files>
  <action>
  Create convex/clinics.ts:

  ```typescript
  import { mutation, query } from "./_generated/server";
  import { v } from "convex/values";

  export const getClinic = query({
    args: { clinicId: v.id("clinics") },
    handler: async (ctx, args) => {
      return await ctx.db.get(args.clinicId);
    },
  });

  export const updateClinicGeneral = mutation({
    args: {
      clinicId: v.id("clinics"),
      name: v.string(),
      taxId: v.string(),
      address: v.string(),
      phone: v.string(),
      email: v.string(),
    },
    handler: async (ctx, args) => {
      const { clinicId, ...updates } = args;
      await ctx.db.patch(clinicId, { ...updates, updatedAt: Date.now() });
    },
  });

  export const updateClinicBot = mutation({
    args: {
      clinicId: v.id("clinics"),
      botConfig: v.object({
        tone: v.union(v.literal("formal"), v.literal("casual"), v.literal("amigable")),
        customPrompts: v.string(),
        faqs: v.array(v.object({
          question: v.string(),
          answer: v.string(),
        })),
        welcomeMessage: v.string(),
        afterHoursMessage: v.string(),
      }),
    },
    handler: async (ctx, args) => {
      await ctx.db.patch(args.clinicId, { botConfig: args.botConfig, updatedAt: Date.now() });
    },
  });

  export const updateClinicTiming = mutation({
    args: {
      clinicId: v.id("clinics"),
      timing: v.object({
        confirmationHours: v.number(),
        reminderHours: v.number(),
        retries: v.number(),
        waitlistTimeout: v.number(),
      }),
    },
    handler: async (ctx, args) => {
      await ctx.db.patch(args.clinicId, { timing: args.timing, updatedAt: Date.now() });
    },
  });

  export const updateClinicAppearance = mutation({
    args: {
      clinicId: v.id("clinics"),
      logo: v.optional(v.id("_storage")),
      colors: v.object({
        primary: v.string(),
        secondary: v.string(),
      }),
    },
    handler: async (ctx, args) => {
      const { clinicId, ...updates } = args;
      await ctx.db.patch(clinicId, { ...updates, updatedAt: Date.now() });
    },
  });

  export const createClinicDraft = mutation({
    args: {
      name: v.string(),
      email: v.string(),
    },
    handler: async (ctx, args) => {
      const clinicId = await ctx.db.insert("clinics", {
        name: args.name,
        slug: args.name.toLowerCase().replace(/\s+/g, "-"),
        taxId: "",
        address: "",
        phone: "",
        email: args.email,
        timezone: "America/Santiago",
        colors: { primary: "#2563eb", secondary: "#64748b" },
        hours: { open: "09:00", close: "18:00" },
        workDays: [1, 2, 3, 4, 5],
        defaultSlotDuration: 30,
        botConfig: {
          tone: "amigable",
          customPrompts: "",
          faqs: [],
          welcomeMessage: "¡Hola! Soy el asistente de la clínica.",
          afterHoursMessage: "Estamos fuera de horario. Te contactaremos pronto.",
        },
        timing: {
          confirmationHours: 24,
          reminderHours: 2,
          retries: 3,
          waitlistTimeout: 30,
        },
        waitlistConfig: {
          priorityWeights: { urgency: 30, patientHistory: 25, waitTime: 25, fifo: 20 },
          notificationMethod: "sequential",
          broadcastLimit: 3,
          responseTimeout: 30,
          urgentTimeout: 15,
          onReject: "keep",
        },
        customPatientFields: [],
        onboardingCompleted: false,
        active: true,
        createdAt: Date.now(),
        updatedAt: Date.now(),
      });
      return clinicId;
    },
  });
  ```

  Run npx convex dev to deploy.
  </action>
  <verify>npx convex dev shows mutations deployed</verify>
  <done>Settings mutations ready</done>
</task>

</tasks>

<verification>
- [ ] convex/clinics.ts exists
- [ ] All update mutations work
- [ ] createClinicDraft works
</verification>

<success_criteria>
- All clinic mutations deployed
- Can update clinic settings
</success_criteria>

<output>
Create `.planning/phases/01-foundation-auth-onboarding/01-09-SUMMARY.md`
</output>
