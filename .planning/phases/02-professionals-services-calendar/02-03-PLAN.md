---
phase: 02-professionals-services-calendar
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/lib/validators.ts
autonomous: true

must_haves:
  truths:
    - "Professionals table exists with all required fields"
    - "ProfessionalExceptions table exists for vacations/absences"
    - "Schedule validator is reusable across files"
  artifacts:
    - path: "convex/schema.ts"
      provides: "professionals and professionalExceptions tables"
      contains: "professionals"
    - path: "convex/lib/validators.ts"
      provides: "Reusable validators"
      exports: ["dayScheduleValidator", "weekScheduleValidator"]
  key_links:
    - from: "convex/schema.ts:professionalExceptions"
      to: "convex/schema.ts:professionals"
      via: "professionalId foreign key"
      pattern: "professionalId: v.id\\(\"professionals\"\\)"
---

<objective>
Add professionals and professionalExceptions tables to Convex schema, plus reusable validators.

Purpose: Backend data model for professionals CRUD - professionals have schedules, exceptions (vacations), and optional calendar connection.
Output: Schema.ts updated with two new tables, validators exported for reuse.
</objective>

<execution_context>
@C:\Users\juana\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\juana\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-professionals-services-calendar/CONTEXT.md
@.planning/phases/02-professionals-services-calendar/02-RESEARCH.md
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validators library</name>
  <files>convex/lib/validators.ts</files>
  <action>
Create convex/lib/validators.ts with reusable schedule validators:

```typescript
import { v } from "convex/values";

// Single day schedule (for professional override)
export const dayScheduleValidator = v.object({
  enabled: v.boolean(),
  start: v.string(),  // "09:00" HH:mm format
  end: v.string(),    // "18:00" HH:mm format
  lunch: v.optional(v.object({
    start: v.string(), // "13:00"
    end: v.string(),   // "14:00"
  })),
});

// Full week schedule (professional can override any day)
export const weekScheduleValidator = v.object({
  monday: v.optional(dayScheduleValidator),
  tuesday: v.optional(dayScheduleValidator),
  wednesday: v.optional(dayScheduleValidator),
  thursday: v.optional(dayScheduleValidator),
  friday: v.optional(dayScheduleValidator),
  saturday: v.optional(dayScheduleValidator),
  sunday: v.optional(dayScheduleValidator),
});
```

Create the convex/lib directory if it doesn't exist (it should exist from Phase 1).
  </action>
  <verify>File exists and exports validators: `cat convex/lib/validators.ts`</verify>
  <done>validators.ts exports dayScheduleValidator and weekScheduleValidator</done>
</task>

<task type="auto">
  <name>Task 2: Add professionals and professionalExceptions tables</name>
  <files>convex/schema.ts</files>
  <action>
Add two new tables to convex/schema.ts. First import the validator at the top:

```typescript
import { weekScheduleValidator } from "./lib/validators";
```

Then add after the services table:

```typescript
// Professionals
professionals: defineTable({
  clinicId: v.id("clinics"),
  userId: v.optional(v.id("users")), // Link to auth user if they have login
  name: v.string(),
  email: v.string(),
  phone: v.string(),
  specialty: v.string(),
  calendarId: v.optional(v.string()), // Google Calendar ID (NOT tokens)
  color: v.string(), // Hex color for agenda display
  serviceIds: v.array(v.id("services")), // Services this professional offers
  schedule: v.optional(weekScheduleValidator), // Override clinic hours, null = use clinic default
  active: v.boolean(),
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_clinic", ["clinicId"])
  .index("by_email", ["email"])
  .index("by_clinic_active", ["clinicId", "active"]),

// Professional Exceptions (vacations, sick days, holidays)
professionalExceptions: defineTable({
  professionalId: v.id("professionals"),
  startDate: v.string(), // YYYY-MM-DD
  endDate: v.string(),   // YYYY-MM-DD
  reason: v.optional(v.string()),
  createdAt: v.number(),
})
  .index("by_professional", ["professionalId"])
  .index("by_professional_dates", ["professionalId", "startDate", "endDate"]),
```

Key decisions from CONTEXT.md:
- calendarId stores Google Calendar ID only (n8n has OAuth)
- schedule is optional override of clinic hours
- serviceIds is array (professional can offer multiple services)
  </action>
  <verify>
Run schema push to validate:
```bash
npx convex dev --once
```
Should succeed without schema validation errors.
  </verify>
  <done>Schema contains professionals and professionalExceptions tables with proper indexes</done>
</task>

</tasks>

<verification>
1. `cat convex/lib/validators.ts` shows dayScheduleValidator and weekScheduleValidator
2. `grep -A 25 "professionals:" convex/schema.ts` shows table with all fields
3. `grep -A 10 "professionalExceptions:" convex/schema.ts` shows exceptions table
4. `npx convex dev --once` succeeds (schema valid)
</verification>

<success_criteria>
- convex/lib/validators.ts exports schedule validators
- professionals table: all fields from CONTEXT.md including calendarId, serviceIds, schedule
- professionalExceptions table: professionalId, startDate, endDate, reason
- Schema pushes successfully to Convex
</success_criteria>

<output>
After completion, create `.planning/phases/02-professionals-services-calendar/02-03-SUMMARY.md`
</output>
