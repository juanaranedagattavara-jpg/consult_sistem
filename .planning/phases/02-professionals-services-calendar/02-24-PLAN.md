---
phase: 02-professionals-services-calendar
plan: 24
type: execute
wave: 7
depends_on: ["02-13", "02-23"]
files_modified:
  - convex/http.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/availability returns slots for date/professional/service"
    - "Returns empty array for invalid combinations"
    - "Error handling for missing parameters"
  artifacts:
    - path: "convex/http.ts"
      provides: "Availability endpoint for n8n"
      contains: "availability"
  key_links:
    - from: "convex/http.ts:/api/availability"
      to: "convex/availability.ts"
      via: "runAction"
      pattern: "availability.getSlots"
---

<objective>
Implement HTTP availability endpoint for n8n.

Purpose: n8n bot needs to query available slots to offer appointment options to patients.
Output: GET /api/availability endpoint that returns available slots.
</objective>

<execution_context>
@C:\Users\juana\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\juana\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-professionals-services-calendar/CONTEXT.md
@convex/http.ts
@convex/availability.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement availability endpoint</name>
  <files>convex/http.ts</files>
  <action>
Update convex/http.ts to replace the placeholder availability endpoint with real implementation:

Find the existing placeholder:
```typescript
app.get("/api/availability", async (c) => {
  return c.json({
    success: true,
    data: [],
    error: null,
  });
});
```

Replace it with:

```typescript
// GET /api/availability - Get available slots for a date/professional/service
app.get("/api/availability", async (c) => {
  const clinic = getClinic(c);

  // Get query parameters
  const professionalId = c.req.query("professionalId");
  const serviceId = c.req.query("serviceId");
  const date = c.req.query("date"); // YYYY-MM-DD

  // Validate required parameters
  if (!professionalId || !serviceId || !date) {
    return c.json(
      {
        success: false,
        data: null,
        error: {
          code: "MISSING_PARAMS",
          message: "Parametros requeridos: professionalId, serviceId, date",
        },
      },
      400
    );
  }

  // Validate date format
  if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) {
    return c.json(
      {
        success: false,
        data: null,
        error: {
          code: "INVALID_DATE",
          message: "Formato de fecha invalido. Use YYYY-MM-DD",
        },
      },
      400
    );
  }

  try {
    const result = await c.env.runAction(api.availability.getSlots, {
      clinicId: clinic._id,
      professionalId: professionalId as Id<"professionals">,
      serviceId: serviceId as Id<"services">,
      date,
    });

    return c.json({
      success: true,
      data: {
        date: result.date,
        professionalId: result.professionalId,
        serviceId: result.serviceId,
        serviceDuration: result.serviceDuration,
        slots: result.slots.map((slot) => ({
          start: slot.start,
          end: slot.end,
        })),
      },
      error: null,
    });
  } catch (error) {
    const message = error instanceof Error ? error.message : "Error desconocido";

    // Check for specific errors
    if (message.includes("no encontrad")) {
      return c.json(
        {
          success: false,
          data: null,
          error: { code: "NOT_FOUND", message },
        },
        404
      );
    }

    if (message.includes("no ofrece este servicio")) {
      return c.json(
        {
          success: false,
          data: null,
          error: { code: "INVALID_COMBINATION", message },
        },
        400
      );
    }

    return c.json(
      {
        success: false,
        data: null,
        error: { code: "INTERNAL_ERROR", message },
      },
      500
    );
  }
});
```

Make sure to update the imports at the top if api is not already imported:
```typescript
import { api, internal } from "./_generated/api";
```
  </action>
  <verify>
Run Convex to verify no errors:
```bash
npx convex dev --once
```
  </verify>
  <done>Availability endpoint returns slots for given parameters</done>
</task>

</tasks>

<verification>
1. `grep -A 40 'GET.*availability' convex/http.ts` shows endpoint
2. `npx convex dev --once` succeeds
3. Endpoint validates required parameters
</verification>

<success_criteria>
- GET /api/availability accepts professionalId, serviceId, date query params
- Returns 400 if parameters missing or date format invalid
- Returns 404 if professional/service not found
- Returns 400 if professional doesn't offer service
- Returns array of { start, end } slots on success
- Response format matches CONTEXT.md spec
</success_criteria>

<output>
After completion, create `.planning/phases/02-professionals-services-calendar/02-24-SUMMARY.md`
</output>
