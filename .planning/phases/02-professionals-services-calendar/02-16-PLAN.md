---
phase: 02-professionals-services-calendar
plan: 16
type: execute
wave: 5
depends_on: ["02-06", "02-08", "02-10"]
files_modified:
  - src/lib/validators/professional.ts
  - src/components/professionals/professional-form.tsx
autonomous: true

must_haves:
  truths:
    - "Professional form has all basic fields"
    - "Services multi-select works"
    - "Color picker is required"
    - "Email validation included"
  artifacts:
    - path: "src/components/professionals/professional-form.tsx"
      provides: "Professional create/edit form (basic fields)"
      exports: ["ProfessionalForm"]
    - path: "src/lib/validators/professional.ts"
      provides: "Zod schema for professional"
      exports: ["professionalSchema"]
  key_links:
    - from: "src/components/professionals/professional-form.tsx"
      to: "convex/professionals.ts"
      via: "useMutation"
      pattern: "useMutation.*professionals"
---

<objective>
Create professional form component with basic fields and service multi-select.

Purpose: Admin needs form to create/edit professionals with contact info, specialty, services, and color.
Output: ProfessionalForm component and Zod validator (schedule and calendar handled in separate components).
</objective>

<execution_context>
@C:\Users\juana\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\juana\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-professionals-services-calendar/CONTEXT.md
@convex/professionals.ts
@src/components/ui/multi-select.tsx
@src/components/ui/color-picker.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create professional validator</name>
  <files>src/lib/validators/professional.ts</files>
  <action>
Create src/lib/validators/professional.ts:

```typescript
import { z } from "zod";

export const professionalSchema = z.object({
  name: z.string().min(1, "El nombre es requerido").max(100, "Maximo 100 caracteres"),
  email: z.string().email("Email invalido"),
  phone: z.string().min(1, "El telefono es requerido").max(20, "Maximo 20 caracteres"),
  specialty: z.string().min(1, "La especialidad es requerida").max(100, "Maximo 100 caracteres"),
  color: z.string().min(1, "El color es requerido"),
  serviceIds: z.array(z.string()).min(1, "Selecciona al menos un servicio"),
});

export type ProfessionalFormValues = z.infer<typeof professionalSchema>;

// Schedule validator (used separately in schedule-editor)
export const dayScheduleSchema = z.object({
  enabled: z.boolean(),
  start: z.string(),
  end: z.string(),
  lunch: z.object({
    start: z.string(),
    end: z.string(),
  }).optional(),
});

export const weekScheduleSchema = z.object({
  monday: dayScheduleSchema.optional(),
  tuesday: dayScheduleSchema.optional(),
  wednesday: dayScheduleSchema.optional(),
  thursday: dayScheduleSchema.optional(),
  friday: dayScheduleSchema.optional(),
  saturday: dayScheduleSchema.optional(),
  sunday: dayScheduleSchema.optional(),
});

export type WeekScheduleFormValues = z.infer<typeof weekScheduleSchema>;
```
  </action>
  <verify>`cat src/lib/validators/professional.ts` shows schema</verify>
  <done>Professional validator with all basic fields</done>
</task>

<task type="auto">
  <name>Task 2: Create professional form component</name>
  <files>src/components/professionals/professional-form.tsx</files>
  <action>
Create src/components/professionals/professional-form.tsx:

```tsx
"use client";

import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { useMutation, useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";
import { Id } from "@/convex/_generated/dataModel";
import { toast } from "sonner";

import { Button } from "@/components/ui/button";
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { MultiSelect } from "@/components/ui/multi-select";
import { ColorPicker } from "@/components/ui/color-picker";
import { professionalSchema, type ProfessionalFormValues } from "@/lib/validators/professional";

interface ProfessionalFormProps {
  clinicId: Id<"clinics">;
  professional?: {
    _id: Id<"professionals">;
    name: string;
    email: string;
    phone: string;
    specialty: string;
    color: string;
    serviceIds: Id<"services">[];
  };
  onSuccess?: () => void;
  onCancel?: () => void;
}

export function ProfessionalForm({
  clinicId,
  professional,
  onSuccess,
  onCancel,
}: ProfessionalFormProps) {
  const services = useQuery(api.services.listActive, { clinicId });
  const createProfessional = useMutation(api.professionals.create);
  const updateProfessional = useMutation(api.professionals.update);

  const isEditing = !!professional;

  const form = useForm<ProfessionalFormValues>({
    resolver: zodResolver(professionalSchema),
    defaultValues: {
      name: professional?.name ?? "",
      email: professional?.email ?? "",
      phone: professional?.phone ?? "",
      specialty: professional?.specialty ?? "",
      color: professional?.color ?? "#2563eb",
      serviceIds: professional?.serviceIds?.map(String) ?? [],
    },
  });

  async function onSubmit(data: ProfessionalFormValues) {
    try {
      if (isEditing) {
        await updateProfessional({
          professionalId: professional._id,
          name: data.name,
          email: data.email,
          phone: data.phone,
          specialty: data.specialty,
          color: data.color,
          serviceIds: data.serviceIds as Id<"services">[],
        });
        toast.success("Profesional actualizado");
      } else {
        await createProfessional({
          clinicId,
          name: data.name,
          email: data.email,
          phone: data.phone,
          specialty: data.specialty,
          color: data.color,
          serviceIds: data.serviceIds as Id<"services">[],
        });
        toast.success("Profesional creado");
      }
      onSuccess?.();
    } catch (error) {
      toast.error(error instanceof Error ? error.message : "Error al guardar");
    }
  }

  const serviceOptions = (services ?? []).map((s) => ({
    value: s._id,
    label: s.name,
  }));

  if (services === undefined) {
    return (
      <Card>
        <CardContent className="py-8 text-center text-muted-foreground">
          Cargando...
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>
          {isEditing ? "Editar profesional" : "Nuevo profesional"}
        </CardTitle>
      </CardHeader>
      <CardContent>
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
            {/* Name */}
            <FormField
              control={form.control}
              name="name"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Nombre completo *</FormLabel>
                  <FormControl>
                    <Input placeholder="Dr. Juan Perez" {...field} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <div className="grid grid-cols-2 gap-4">
              {/* Email */}
              <FormField
                control={form.control}
                name="email"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Email *</FormLabel>
                    <FormControl>
                      <Input type="email" placeholder="doctor@clinica.com" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              {/* Phone */}
              <FormField
                control={form.control}
                name="phone"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Telefono *</FormLabel>
                    <FormControl>
                      <Input placeholder="+56 9 1234 5678" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            {/* Specialty */}
            <FormField
              control={form.control}
              name="specialty"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Especialidad *</FormLabel>
                  <FormControl>
                    <Input placeholder="Odontologia general, Ortodoncia..." {...field} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            {/* Services */}
            <FormField
              control={form.control}
              name="serviceIds"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Servicios que ofrece *</FormLabel>
                  <FormControl>
                    <MultiSelect
                      options={serviceOptions}
                      selected={field.value}
                      onChange={field.onChange}
                      placeholder="Seleccionar servicios..."
                      emptyMessage="No hay servicios disponibles"
                    />
                  </FormControl>
                  <FormDescription>
                    Selecciona los servicios que este profesional puede realizar
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />

            {/* Color */}
            <FormField
              control={form.control}
              name="color"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Color *</FormLabel>
                  <FormControl>
                    <ColorPicker value={field.value} onChange={field.onChange} />
                  </FormControl>
                  <FormDescription>
                    Color para identificar en la agenda
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />

            {/* Actions */}
            <div className="flex justify-end gap-2">
              {onCancel && (
                <Button type="button" variant="outline" onClick={onCancel}>
                  Cancelar
                </Button>
              )}
              <Button type="submit" disabled={form.formState.isSubmitting}>
                {form.formState.isSubmitting
                  ? "Guardando..."
                  : isEditing
                  ? "Guardar cambios"
                  : "Crear profesional"}
              </Button>
            </div>
          </form>
        </Form>
      </CardContent>
    </Card>
  );
}
```

Create src/components/professionals directory if it doesn't exist.
  </action>
  <verify>No TypeScript errors: `npx tsc --noEmit`</verify>
  <done>ProfessionalForm handles create/edit with basic fields</done>
</task>

</tasks>

<verification>
1. `cat src/lib/validators/professional.ts` shows schema
2. `cat src/components/professionals/professional-form.tsx` shows form
3. `npx tsc --noEmit` succeeds
</verification>

<success_criteria>
- Professional validator has all basic fields
- Form shows all fields from CONTEXT.md
- MultiSelect for services works correctly
- ColorPicker integrated and required
- Email uniqueness error displays properly (from mutation)
</success_criteria>

<output>
After completion, create `.planning/phases/02-professionals-services-calendar/02-16-SUMMARY.md`
</output>
