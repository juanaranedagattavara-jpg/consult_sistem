---
phase: 02-professionals-services-calendar
plan: 13
type: execute
wave: 4
depends_on: ["02-04", "02-05", "02-06", "02-12"]
files_modified:
  - convex/http.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/professionals returns list with calendarIds"
    - "GET /api/professionals/:id returns single professional"
    - "GET /api/services returns active services with durations"
    - "GET /api/categories returns service categories"
  artifacts:
    - path: "convex/http.ts"
      provides: "n8n API endpoints"
      contains: "professionals"
  key_links:
    - from: "convex/http.ts"
      to: "convex/professionals.ts"
      via: "runQuery"
      pattern: "professionals.list"
---

<objective>
Implement HTTP endpoints for professionals, services, and categories.

Purpose: n8n workflow needs to fetch professionals and services to offer appointment options.
Output: Working GET endpoints for professionals, services, and categories.
</objective>

<execution_context>
@C:\Users\juana\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\juana\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-professionals-services-calendar/CONTEXT.md
@convex/http.ts
@convex/professionals.ts
@convex/services.ts
@convex/serviceCategories.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement professionals, services, categories endpoints</name>
  <files>convex/http.ts</files>
  <action>
Update convex/http.ts to implement the real endpoints. Replace the placeholder routes with actual implementations:

```typescript
// Add imports at top
import { api, internal } from "./_generated/api";

// Helper to get clinic from context
function getClinic(c: any) {
  return c.get("clinic" as never) as {
    _id: Id<"clinics">;
    name: string;
  };
}

// --- PROFESSIONALS ---

// GET /api/professionals - List all professionals
app.get("/api/professionals", async (c) => {
  const clinic = getClinic(c);

  try {
    const professionals = await c.env.runQuery(api.professionals.listActive, {
      clinicId: clinic._id,
    });

    return c.json({
      success: true,
      data: professionals.map((p) => ({
        id: p._id,
        name: p.name,
        email: p.email,
        specialty: p.specialty,
        calendarId: p.calendarId ?? null,
        color: p.color,
        active: p.active,
      })),
      error: null,
    });
  } catch (error) {
    return c.json(
      {
        success: false,
        data: null,
        error: { code: "INTERNAL_ERROR", message: String(error) },
      },
      500
    );
  }
});

// GET /api/professionals/:id - Get single professional
app.get("/api/professionals/:id", async (c) => {
  const clinic = getClinic(c);
  const professionalId = c.req.param("id") as Id<"professionals">;

  try {
    const professional = await c.env.runQuery(api.professionals.get, {
      professionalId,
    });

    if (!professional || professional.clinicId !== clinic._id) {
      return c.json(
        {
          success: false,
          data: null,
          error: { code: "NOT_FOUND", message: "Profesional no encontrado" },
        },
        404
      );
    }

    return c.json({
      success: true,
      data: {
        id: professional._id,
        name: professional.name,
        email: professional.email,
        phone: professional.phone,
        specialty: professional.specialty,
        calendarId: professional.calendarId ?? null,
        color: professional.color,
        serviceIds: professional.serviceIds,
        schedule: professional.schedule ?? null,
        active: professional.active,
      },
      error: null,
    });
  } catch (error) {
    return c.json(
      {
        success: false,
        data: null,
        error: { code: "INTERNAL_ERROR", message: String(error) },
      },
      500
    );
  }
});

// --- SERVICES ---

// GET /api/services - List active services
app.get("/api/services", async (c) => {
  const clinic = getClinic(c);

  try {
    const services = await c.env.runQuery(api.services.listActive, {
      clinicId: clinic._id,
    });

    return c.json({
      success: true,
      data: services.map((s) => ({
        id: s._id,
        name: s.name,
        description: s.description ?? null,
        duration: s.duration,
        price: s.price ?? null,
        categoryId: s.categoryId,
        color: s.color ?? null,
      })),
      error: null,
    });
  } catch (error) {
    return c.json(
      {
        success: false,
        data: null,
        error: { code: "INTERNAL_ERROR", message: String(error) },
      },
      500
    );
  }
});

// GET /api/services/:id - Get single service
app.get("/api/services/:id", async (c) => {
  const clinic = getClinic(c);
  const serviceId = c.req.param("id") as Id<"services">;

  try {
    const service = await c.env.runQuery(api.services.get, { serviceId });

    if (!service || service.clinicId !== clinic._id) {
      return c.json(
        {
          success: false,
          data: null,
          error: { code: "NOT_FOUND", message: "Servicio no encontrado" },
        },
        404
      );
    }

    return c.json({
      success: true,
      data: {
        id: service._id,
        name: service.name,
        description: service.description ?? null,
        duration: service.duration,
        price: service.price ?? null,
        categoryId: service.categoryId,
        color: service.color ?? null,
        active: service.active,
      },
      error: null,
    });
  } catch (error) {
    return c.json(
      {
        success: false,
        data: null,
        error: { code: "INTERNAL_ERROR", message: String(error) },
      },
      500
    );
  }
});

// --- CATEGORIES ---

// GET /api/categories - List service categories
app.get("/api/categories", async (c) => {
  const clinic = getClinic(c);

  try {
    const categories = await c.env.runQuery(api.serviceCategories.list, {
      clinicId: clinic._id,
    });

    return c.json({
      success: true,
      data: categories.map((cat) => ({
        id: cat._id,
        name: cat.name,
        order: cat.order,
      })),
      error: null,
    });
  } catch (error) {
    return c.json(
      {
        success: false,
        data: null,
        error: { code: "INTERNAL_ERROR", message: String(error) },
      },
      500
    );
  }
});
```

Key points:
- All endpoints validate clinic ownership
- Response format matches CONTEXT.md spec
- Error responses include code and message
- Null values explicitly returned (not undefined)
  </action>
  <verify>
Run Convex to verify no errors:
```bash
npx convex dev --once
```
  </verify>
  <done>HTTP endpoints return real data from Convex queries</done>
</task>

</tasks>

<verification>
1. `grep -A 5 'GET.*professionals' convex/http.ts` shows endpoint
2. `npx convex dev --once` succeeds
3. Response format matches CONTEXT.md spec
</verification>

<success_criteria>
- GET /api/professionals returns list with all fields
- GET /api/professionals/:id returns single professional
- GET /api/services returns active services
- GET /api/services/:id returns single service
- GET /api/categories returns ordered categories
- All endpoints validate clinic ownership
</success_criteria>

<output>
After completion, create `.planning/phases/02-professionals-services-calendar/02-13-SUMMARY.md`
</output>
