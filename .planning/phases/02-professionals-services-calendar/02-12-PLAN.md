---
phase: 02-professionals-services-calendar
plan: 12
type: execute
wave: 4
depends_on: ["02-01", "02-02"]
files_modified:
  - convex/schema.ts
  - convex/clinics.ts
  - convex/http.ts
autonomous: true

must_haves:
  truths:
    - "Clinic has apiKey field in schema"
    - "API key middleware validates requests"
    - "Hono router handles /api/* routes"
    - "CORS enabled for all origins"
  artifacts:
    - path: "convex/http.ts"
      provides: "HTTP router with Hono"
      contains: "HonoWithConvex"
    - path: "convex/clinics.ts"
      provides: "API key generation and lookup"
      exports: ["generateApiKey", "getByApiKey"]
  key_links:
    - from: "convex/http.ts"
      to: "convex/clinics.ts"
      via: "getByApiKey lookup"
      pattern: "getByApiKey"
---

<objective>
Set up Hono HTTP router with API key authentication for n8n.

Purpose: n8n workflow needs HTTP API to interact with the system - requires authenticated endpoints.
Output: HTTP router with CORS, API key middleware, and basic structure.
</objective>

<execution_context>
@C:\Users\juana\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\juana\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-professionals-services-calendar/CONTEXT.md
@.planning/phases/02-professionals-services-calendar/02-RESEARCH.md
@convex/schema.ts
@convex/http.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add apiKey field to clinics schema</name>
  <files>convex/schema.ts</files>
  <action>
Modify convex/schema.ts to add apiKey field to clinics table.

Add these fields to the clinics table definition (after active: v.boolean()):

```typescript
// API Key for n8n integration
apiKey: v.optional(v.string()),
```

Add this index to the clinics table (after .index("by_email", ["email"])):

```typescript
.index("by_api_key", ["apiKey"])
```
  </action>
  <verify>`grep -A 2 "apiKey" convex/schema.ts` shows field and index</verify>
  <done>clinics table has apiKey field with by_api_key index</done>
</task>

<task type="auto">
  <name>Task 2: Add API key functions to clinics.ts</name>
  <files>convex/clinics.ts</files>
  <action>
Add API key generation and lookup functions to convex/clinics.ts:

```typescript
import { v } from "convex/values";
import { mutation, query, internalQuery } from "./_generated/server";

// Generate random API key
function generateRandomKey(): string {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  let key = "ck_"; // clinic key prefix
  for (let i = 0; i < 32; i++) {
    key += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return key;
}

// Generate new API key for clinic
export const generateApiKey = mutation({
  args: { clinicId: v.id("clinics") },
  handler: async (ctx, args) => {
    const apiKey = generateRandomKey();
    await ctx.db.patch(args.clinicId, {
      apiKey,
      updatedAt: Date.now(),
    });
    return apiKey;
  },
});

// Get clinic by API key (for HTTP middleware)
export const getByApiKey = internalQuery({
  args: { apiKey: v.string() },
  handler: async (ctx, args) => {
    return await ctx.db
      .query("clinics")
      .withIndex("by_api_key", (q) => q.eq("apiKey", args.apiKey))
      .first();
  },
});

// Get clinic's API key (for settings display)
export const getApiKey = query({
  args: { clinicId: v.id("clinics") },
  handler: async (ctx, args) => {
    const clinic = await ctx.db.get(args.clinicId);
    return clinic?.apiKey ?? null;
  },
});

// Revoke API key
export const revokeApiKey = mutation({
  args: { clinicId: v.id("clinics") },
  handler: async (ctx, args) => {
    await ctx.db.patch(args.clinicId, {
      apiKey: undefined,
      updatedAt: Date.now(),
    });
  },
});
```

If clinics.ts doesn't exist, create it. If it exists, add these functions to the existing file.
  </action>
  <verify>`grep -E "generateApiKey|getByApiKey" convex/clinics.ts` shows both functions</verify>
  <done>clinics.ts exports generateApiKey, getByApiKey, getApiKey, revokeApiKey</done>
</task>

<task type="auto">
  <name>Task 3: Create Hono HTTP router</name>
  <files>convex/http.ts</files>
  <action>
Replace convex/http.ts with Hono-based router:

```typescript
import { Hono } from "hono";
import { cors } from "hono/cors";
import { HonoWithConvex, HttpRouterWithHono } from "convex-helpers/server/hono";
import { ActionCtx } from "./_generated/server";
import { internal } from "./_generated/api";
import { Id } from "./_generated/dataModel";

// Create Hono app with Convex context
const app: HonoWithConvex<ActionCtx> = new Hono();

// CORS middleware for all API routes
app.use("/api/*", cors({
  origin: "*", // Allow all origins for n8n
  allowMethods: ["GET", "POST", "PATCH", "DELETE", "OPTIONS"],
  allowHeaders: ["Content-Type", "X-API-Key"],
}));

// Types for context
type ClinicContext = {
  clinic: {
    _id: Id<"clinics">;
    name: string;
    // ... other fields
  };
};

// API Key authentication middleware
app.use("/api/*", async (c, next) => {
  const apiKey = c.req.header("X-API-Key");

  if (!apiKey) {
    return c.json(
      {
        success: false,
        data: null,
        error: { code: "UNAUTHORIZED", message: "API Key required" },
      },
      401
    );
  }

  // Validate API key
  const clinic = await c.env.runQuery(internal.clinics.getByApiKey, { apiKey });

  if (!clinic) {
    return c.json(
      {
        success: false,
        data: null,
        error: { code: "INVALID_API_KEY", message: "Invalid API Key" },
      },
      401
    );
  }

  // Store clinic in context for handlers
  c.set("clinic" as never, clinic as never);
  await next();
});

// Health check (no auth required)
app.get("/health", (c) => {
  return c.json({ status: "ok", timestamp: Date.now() });
});

// Placeholder API routes (to be implemented in subsequent plans)
app.get("/api/professionals", async (c) => {
  return c.json({
    success: true,
    data: [],
    error: null,
  });
});

app.get("/api/services", async (c) => {
  return c.json({
    success: true,
    data: [],
    error: null,
  });
});

app.get("/api/availability", async (c) => {
  return c.json({
    success: true,
    data: [],
    error: null,
  });
});

// Export HTTP router
export default new HttpRouterWithHono(app);
```

NOTE: If http.ts has existing auth routes, preserve them and add the Hono routes alongside.
  </action>
  <verify>
Run Convex to verify no errors:
```bash
npx convex dev --once
```
  </verify>
  <done>http.ts uses Hono with CORS and API key middleware</done>
</task>

</tasks>

<verification>
1. Schema has apiKey field with index
2. clinics.ts has API key generation functions
3. http.ts uses HonoWithConvex pattern
4. CORS headers include X-API-Key
5. `npx convex dev --once` succeeds
</verification>

<success_criteria>
- Clinic schema includes apiKey field with by_api_key index
- generateApiKey creates 35-char key with "ck_" prefix
- getByApiKey looks up clinic by API key
- HTTP router validates X-API-Key header
- CORS allows all origins with required headers
</success_criteria>

<output>
After completion, create `.planning/phases/02-professionals-services-calendar/02-12-SUMMARY.md`
</output>
