---
phase: 02-professionals-services-calendar
plan: 19
type: execute
wave: 6
depends_on: ["02-14", "02-15", "02-05"]
files_modified:
  - src/components/services/service-list.tsx
  - src/app/(dashboard)/servicios/page.tsx
autonomous: true

must_haves:
  truths:
    - "Services grouped by category in accordion"
    - "Can drag-drop to reorder services within category"
    - "Can toggle service active/inactive"
    - "Can duplicate service"
    - "Can edit and delete services"
  artifacts:
    - path: "src/components/services/service-list.tsx"
      provides: "Services list with categories"
      exports: ["ServiceList"]
    - path: "src/app/(dashboard)/servicios/page.tsx"
      provides: "Services page"
  key_links:
    - from: "src/components/services/service-list.tsx"
      to: "convex/services.ts"
      via: "useMutation"
      pattern: "useMutation.*services"
---

<objective>
Create services page with category accordion and drag-drop ordering.

Purpose: Admin manages services grouped by category - can reorder, toggle status, duplicate, edit, delete.
Output: Services page with ServiceList component featuring accordion layout and dnd-kit sorting.
</objective>

<execution_context>
@C:\Users\juana\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\juana\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-professionals-services-calendar/CONTEXT.md
@convex/services.ts
@convex/serviceCategories.ts
@src/components/services/service-form.tsx
@src/components/services/category-list.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create service list component</name>
  <files>src/components/services/service-list.tsx</files>
  <action>
Create src/components/services/service-list.tsx with accordion and drag-drop:

```tsx
"use client";

import { useState } from "react";
import { useQuery, useMutation } from "convex/react";
import { api } from "@/convex/_generated/api";
import { Id } from "@/convex/_generated/dataModel";
import { toast } from "sonner";
import {
  DndContext,
  closestCenter,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
  DragEndEvent,
} from "@dnd-kit/core";
import {
  arrayMove,
  SortableContext,
  sortableKeyboardCoordinates,
  verticalListSortingStrategy,
  useSortable,
} from "@dnd-kit/sortable";
import { CSS } from "@dnd-kit/utilities";
import {
  GripVertical,
  Pencil,
  Trash2,
  Copy,
  MoreVertical,
  Package,
} from "lucide-react";

import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Switch } from "@/components/ui/switch";
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from "@/components/ui/accordion";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";

interface SortableServiceItemProps {
  service: {
    _id: Id<"services">;
    name: string;
    duration: number;
    price?: number;
    color?: string;
    active: boolean;
  };
  onEdit: () => void;
  onDelete: () => void;
  onDuplicate: () => void;
  onToggle: () => void;
}

function SortableServiceItem({
  service,
  onEdit,
  onDelete,
  onDuplicate,
  onToggle,
}: SortableServiceItemProps) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging,
  } = useSortable({ id: service._id });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1,
  };

  return (
    <div
      ref={setNodeRef}
      style={style}
      className="flex items-center gap-3 p-3 rounded-lg border bg-card hover:bg-muted/50 transition-colors"
    >
      {/* Drag Handle */}
      <button
        className="cursor-grab touch-none text-muted-foreground hover:text-foreground"
        {...attributes}
        {...listeners}
      >
        <GripVertical className="h-5 w-5" />
      </button>

      {/* Color indicator */}
      {service.color && (
        <div
          className="w-3 h-8 rounded-full"
          style={{ backgroundColor: service.color }}
        />
      )}

      {/* Service info */}
      <div className="flex-1 min-w-0">
        <p className={`font-medium ${!service.active ? "text-muted-foreground" : ""}`}>
          {service.name}
        </p>
        <p className="text-sm text-muted-foreground">
          {service.duration} min
          {service.price !== undefined && ` • $${service.price.toLocaleString()}`}
        </p>
      </div>

      {/* Active toggle */}
      <Switch checked={service.active} onCheckedChange={onToggle} />

      {/* Actions menu */}
      <DropdownMenu>
        <DropdownMenuTrigger asChild>
          <Button variant="ghost" size="icon">
            <MoreVertical className="h-4 w-4" />
          </Button>
        </DropdownMenuTrigger>
        <DropdownMenuContent align="end">
          <DropdownMenuItem onClick={onEdit}>
            <Pencil className="h-4 w-4 mr-2" />
            Editar
          </DropdownMenuItem>
          <DropdownMenuItem onClick={onDuplicate}>
            <Copy className="h-4 w-4 mr-2" />
            Duplicar
          </DropdownMenuItem>
          <DropdownMenuItem onClick={onDelete} className="text-destructive">
            <Trash2 className="h-4 w-4 mr-2" />
            Eliminar
          </DropdownMenuItem>
        </DropdownMenuContent>
      </DropdownMenu>
    </div>
  );
}

interface ServiceListProps {
  clinicId: Id<"clinics">;
  onEdit: (serviceId: Id<"services">) => void;
}

export function ServiceList({ clinicId, onEdit }: ServiceListProps) {
  const categories = useQuery(api.serviceCategories.list, { clinicId });
  const services = useQuery(api.services.list, { clinicId });
  const reorderServices = useMutation(api.services.reorder);
  const toggleActive = useMutation(api.services.toggleActive);
  const duplicateService = useMutation(api.services.duplicate);
  const removeService = useMutation(api.services.remove);

  const [deletingService, setDeletingService] = useState<Id<"services"> | null>(null);

  const sensors = useSensors(
    useSensor(PointerSensor),
    useSensor(KeyboardSensor, { coordinateGetter: sortableKeyboardCoordinates })
  );

  // Group services by category
  const servicesByCategory = categories?.reduce(
    (acc, cat) => {
      acc[cat._id] = (services || [])
        .filter((s) => s.categoryId === cat._id)
        .sort((a, b) => a.order - b.order);
      return acc;
    },
    {} as Record<Id<"serviceCategories">, typeof services>
  );

  async function handleDragEnd(
    event: DragEndEvent,
    categoryId: Id<"serviceCategories">
  ) {
    const { active, over } = event;
    if (!over || active.id === over.id) return;

    const categoryServices = servicesByCategory?.[categoryId] || [];
    const oldIndex = categoryServices.findIndex((s) => s._id === active.id);
    const newIndex = categoryServices.findIndex((s) => s._id === over.id);

    const newOrder = arrayMove(categoryServices, oldIndex, newIndex);

    try {
      await reorderServices({
        categoryId,
        serviceIds: newOrder.map((s) => s._id),
      });
    } catch (error) {
      toast.error("Error al reordenar");
    }
  }

  async function handleToggle(serviceId: Id<"services">) {
    try {
      await toggleActive({ serviceId });
    } catch (error) {
      toast.error("Error al cambiar estado");
    }
  }

  async function handleDuplicate(serviceId: Id<"services">) {
    try {
      await duplicateService({ serviceId });
      toast.success("Servicio duplicado");
    } catch (error) {
      toast.error("Error al duplicar");
    }
  }

  async function handleDelete() {
    if (!deletingService) return;
    try {
      await removeService({ serviceId: deletingService });
      toast.success("Servicio eliminado");
      setDeletingService(null);
    } catch (error) {
      toast.error("Error al eliminar");
    }
  }

  if (!categories || !services) {
    return <div className="text-center py-8 text-muted-foreground">Cargando...</div>;
  }

  if (categories.length === 0) {
    return (
      <div className="text-center py-12 text-muted-foreground">
        <Package className="h-12 w-12 mx-auto mb-4 opacity-50" />
        <p>No hay categorias</p>
        <p className="text-sm mt-1">Crea una categoria para agregar servicios</p>
      </div>
    );
  }

  return (
    <>
      <Accordion type="multiple" defaultValue={categories.map((c) => c._id)} className="space-y-2">
        {categories.map((category) => {
          const categoryServices = servicesByCategory?.[category._id] || [];

          return (
            <AccordionItem key={category._id} value={category._id} className="border rounded-lg">
              <AccordionTrigger className="px-4 hover:no-underline">
                <div className="flex items-center gap-2">
                  <span className="font-medium">{category.name}</span>
                  <Badge variant="secondary">{categoryServices.length}</Badge>
                </div>
              </AccordionTrigger>
              <AccordionContent className="px-4 pb-4">
                {categoryServices.length === 0 ? (
                  <p className="text-sm text-muted-foreground py-4 text-center">
                    Sin servicios en esta categoria
                  </p>
                ) : (
                  <DndContext
                    sensors={sensors}
                    collisionDetection={closestCenter}
                    onDragEnd={(e) => handleDragEnd(e, category._id)}
                  >
                    <SortableContext
                      items={categoryServices.map((s) => s._id)}
                      strategy={verticalListSortingStrategy}
                    >
                      <div className="space-y-2">
                        {categoryServices.map((service) => (
                          <SortableServiceItem
                            key={service._id}
                            service={service}
                            onEdit={() => onEdit(service._id)}
                            onDelete={() => setDeletingService(service._id)}
                            onDuplicate={() => handleDuplicate(service._id)}
                            onToggle={() => handleToggle(service._id)}
                          />
                        ))}
                      </div>
                    </SortableContext>
                  </DndContext>
                )}
              </AccordionContent>
            </AccordionItem>
          );
        })}
      </Accordion>

      {/* Delete Confirmation */}
      <AlertDialog
        open={!!deletingService}
        onOpenChange={(open) => !open && setDeletingService(null)}
      >
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Eliminar servicio</AlertDialogTitle>
            <AlertDialogDescription>
              ¿Estas seguro de eliminar este servicio? Esta accion no se puede deshacer.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Cancelar</AlertDialogCancel>
            <AlertDialogAction
              onClick={handleDelete}
              className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
            >
              Eliminar
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </>
  );
}
```
  </action>
  <verify>No TypeScript errors: `npx tsc --noEmit`</verify>
  <done>ServiceList with accordion and drag-drop working</done>
</task>

<task type="auto">
  <name>Task 2: Create services page</name>
  <files>src/app/(dashboard)/servicios/page.tsx</files>
  <action>
Create src/app/(dashboard)/servicios/page.tsx:

```tsx
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { Plus, Settings } from "lucide-react";

import { Button } from "@/components/ui/button";
import { useCurrentClinic } from "@/hooks/useCurrentClinic";
import { ServiceList } from "@/components/services/service-list";
import { ServiceForm } from "@/components/services/service-form";
import { CategoryList } from "@/components/services/category-list";
import { Id } from "@/convex/_generated/dataModel";
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
} from "@/components/ui/sheet";

export default function ServiciosPage() {
  const { clinic, isLoading } = useCurrentClinic();
  const router = useRouter();

  const [showForm, setShowForm] = useState(false);
  const [showCategories, setShowCategories] = useState(false);
  const [editingServiceId, setEditingServiceId] = useState<Id<"services"> | null>(null);

  if (isLoading) {
    return (
      <div className="p-6 text-center text-muted-foreground">Cargando...</div>
    );
  }

  if (!clinic) {
    return (
      <div className="p-6 text-center text-muted-foreground">
        No se encontro la clinica
      </div>
    );
  }

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold">Servicios</h1>
        <div className="flex gap-2">
          <Button variant="outline" onClick={() => setShowCategories(true)}>
            <Settings className="h-4 w-4 mr-2" />
            Categorias
          </Button>
          <Button onClick={() => { setEditingServiceId(null); setShowForm(true); }}>
            <Plus className="h-4 w-4 mr-2" />
            Nuevo Servicio
          </Button>
        </div>
      </div>

      {/* Service List */}
      <ServiceList
        clinicId={clinic._id}
        onEdit={(serviceId) => { setEditingServiceId(serviceId); setShowForm(true); }}
      />

      {/* Service Form Sheet */}
      <Sheet open={showForm} onOpenChange={setShowForm}>
        <SheetContent className="sm:max-w-lg overflow-y-auto">
          <SheetHeader>
            <SheetTitle>
              {editingServiceId ? "Editar servicio" : "Nuevo servicio"}
            </SheetTitle>
          </SheetHeader>
          <div className="mt-6">
            {/* Need to fetch service data if editing */}
            <ServiceFormWrapper
              clinicId={clinic._id}
              serviceId={editingServiceId}
              onSuccess={() => setShowForm(false)}
              onCancel={() => setShowForm(false)}
            />
          </div>
        </SheetContent>
      </Sheet>

      {/* Categories Sheet */}
      <Sheet open={showCategories} onOpenChange={setShowCategories}>
        <SheetContent className="sm:max-w-md">
          <SheetHeader>
            <SheetTitle>Categorias de Servicios</SheetTitle>
          </SheetHeader>
          <div className="mt-6">
            <CategoryList clinicId={clinic._id} />
          </div>
        </SheetContent>
      </Sheet>
    </div>
  );
}

// Wrapper to fetch service data when editing
import { useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";

function ServiceFormWrapper({
  clinicId,
  serviceId,
  onSuccess,
  onCancel,
}: {
  clinicId: Id<"clinics">;
  serviceId: Id<"services"> | null;
  onSuccess: () => void;
  onCancel: () => void;
}) {
  const service = useQuery(
    api.services.get,
    serviceId ? { serviceId } : "skip"
  );

  if (serviceId && service === undefined) {
    return <div className="text-center py-4 text-muted-foreground">Cargando...</div>;
  }

  return (
    <ServiceForm
      clinicId={clinicId}
      service={service ?? undefined}
      onSuccess={onSuccess}
      onCancel={onCancel}
    />
  );
}
```

Note: This requires the Sheet component from shadcn. Install if not present: `npx shadcn@latest add sheet`
  </action>
  <verify>No TypeScript errors: `npx tsc --noEmit`</verify>
  <done>Services page with form sheet and category management</done>
</task>

</tasks>

<verification>
1. `cat src/components/services/service-list.tsx` shows component
2. `cat src/app/(dashboard)/servicios/page.tsx` shows page
3. `npx tsc --noEmit` succeeds
</verification>

<success_criteria>
- Services grouped by category in accordion
- Drag-drop reordering works within categories
- Toggle active/inactive inline
- Edit/duplicate/delete from dropdown menu
- Service form opens in sheet for create/edit
- Categories managed in separate sheet
</success_criteria>

<output>
After completion, create `.planning/phases/02-professionals-services-calendar/02-19-SUMMARY.md`
</output>
