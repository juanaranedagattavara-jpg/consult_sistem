---
phase: 02-professionals-services-calendar
plan: 15
type: execute
wave: 5
depends_on: ["02-05", "02-10"]
files_modified:
  - src/lib/validators/service.ts
  - src/components/services/service-form.tsx
autonomous: true

must_haves:
  truths:
    - "Service form has all required fields"
    - "Category is selectable from dropdown"
    - "Duration is number input in minutes"
    - "Color picker is optional"
  artifacts:
    - path: "src/components/services/service-form.tsx"
      provides: "Service create/edit form"
      exports: ["ServiceForm"]
    - path: "src/lib/validators/service.ts"
      provides: "Zod schema for service"
      exports: ["serviceSchema"]
  key_links:
    - from: "src/components/services/service-form.tsx"
      to: "convex/services.ts"
      via: "useMutation"
      pattern: "useMutation.*services"
---

<objective>
Create service form component with all fields.

Purpose: Admin needs form to create/edit services with category, duration, price, and optional color.
Output: ServiceForm component and Zod validator for services.
</objective>

<execution_context>
@C:\Users\juana\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\juana\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-professionals-services-calendar/CONTEXT.md
@convex/services.ts
@src/components/ui/color-picker.tsx
@src/components/ui/select.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create service validator</name>
  <files>src/lib/validators/service.ts</files>
  <action>
Create src/lib/validators/service.ts:

```typescript
import { z } from "zod";

export const serviceSchema = z.object({
  categoryId: z.string().min(1, "Selecciona una categoria"),
  name: z.string().min(1, "El nombre es requerido").max(100, "Maximo 100 caracteres"),
  description: z.string().max(500, "Maximo 500 caracteres").optional(),
  duration: z.number().min(5, "Minimo 5 minutos").max(480, "Maximo 8 horas"),
  price: z.number().min(0, "El precio no puede ser negativo").optional(),
  color: z.string().optional(),
});

export type ServiceFormValues = z.infer<typeof serviceSchema>;
```

Create src/lib/validators directory if it doesn't exist.
  </action>
  <verify>`cat src/lib/validators/service.ts` shows schema</verify>
  <done>Service validator with all fields defined</done>
</task>

<task type="auto">
  <name>Task 2: Create service form component</name>
  <files>src/components/services/service-form.tsx</files>
  <action>
Create src/components/services/service-form.tsx:

```tsx
"use client";

import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { useMutation, useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";
import { Id } from "@/convex/_generated/dataModel";
import { toast } from "sonner";

import { Button } from "@/components/ui/button";
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { ColorPicker } from "@/components/ui/color-picker";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { serviceSchema, type ServiceFormValues } from "@/lib/validators/service";

interface ServiceFormProps {
  clinicId: Id<"clinics">;
  service?: {
    _id: Id<"services">;
    categoryId: Id<"serviceCategories">;
    name: string;
    description?: string;
    duration: number;
    price?: number;
    color?: string;
  };
  onSuccess?: () => void;
  onCancel?: () => void;
}

export function ServiceForm({
  clinicId,
  service,
  onSuccess,
  onCancel,
}: ServiceFormProps) {
  const categories = useQuery(api.serviceCategories.list, { clinicId });
  const createService = useMutation(api.services.create);
  const updateService = useMutation(api.services.update);

  const isEditing = !!service;

  const form = useForm<ServiceFormValues>({
    resolver: zodResolver(serviceSchema),
    defaultValues: {
      categoryId: service?.categoryId ?? "",
      name: service?.name ?? "",
      description: service?.description ?? "",
      duration: service?.duration ?? 30,
      price: service?.price ?? undefined,
      color: service?.color ?? undefined,
    },
  });

  async function onSubmit(data: ServiceFormValues) {
    try {
      if (isEditing) {
        await updateService({
          serviceId: service._id,
          categoryId: data.categoryId as Id<"serviceCategories">,
          name: data.name,
          description: data.description || undefined,
          duration: data.duration,
          price: data.price,
          color: data.color,
        });
        toast.success("Servicio actualizado");
      } else {
        await createService({
          clinicId,
          categoryId: data.categoryId as Id<"serviceCategories">,
          name: data.name,
          description: data.description || undefined,
          duration: data.duration,
          price: data.price,
          color: data.color,
        });
        toast.success("Servicio creado");
      }
      onSuccess?.();
    } catch (error) {
      toast.error(error instanceof Error ? error.message : "Error al guardar");
    }
  }

  if (categories === undefined) {
    return (
      <Card>
        <CardContent className="py-8 text-center text-muted-foreground">
          Cargando...
        </CardContent>
      </Card>
    );
  }

  if (categories.length === 0) {
    return (
      <Card>
        <CardContent className="py-8 text-center text-muted-foreground">
          <p>No hay categorias disponibles</p>
          <p className="text-sm mt-1">Crea una categoria primero</p>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>{isEditing ? "Editar servicio" : "Nuevo servicio"}</CardTitle>
      </CardHeader>
      <CardContent>
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
            {/* Category */}
            <FormField
              control={form.control}
              name="categoryId"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Categoria *</FormLabel>
                  <Select onValueChange={field.onChange} defaultValue={field.value}>
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue placeholder="Seleccionar categoria..." />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      {categories.map((cat) => (
                        <SelectItem key={cat._id} value={cat._id}>
                          {cat.name}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />

            {/* Name */}
            <FormField
              control={form.control}
              name="name"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Nombre *</FormLabel>
                  <FormControl>
                    <Input placeholder="Ej: Limpieza dental" {...field} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            {/* Description */}
            <FormField
              control={form.control}
              name="description"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Descripcion</FormLabel>
                  <FormControl>
                    <Textarea
                      placeholder="Descripcion del servicio..."
                      className="min-h-[80px]"
                      {...field}
                    />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <div className="grid grid-cols-2 gap-4">
              {/* Duration */}
              <FormField
                control={form.control}
                name="duration"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Duracion (minutos) *</FormLabel>
                    <FormControl>
                      <Input
                        type="number"
                        min={5}
                        max={480}
                        {...field}
                        onChange={(e) => field.onChange(parseInt(e.target.value, 10))}
                      />
                    </FormControl>
                    <FormDescription>Entre 5 y 480 minutos</FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />

              {/* Price */}
              <FormField
                control={form.control}
                name="price"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Precio</FormLabel>
                    <FormControl>
                      <Input
                        type="number"
                        min={0}
                        placeholder="0"
                        {...field}
                        value={field.value ?? ""}
                        onChange={(e) =>
                          field.onChange(
                            e.target.value ? parseInt(e.target.value, 10) : undefined
                          )
                        }
                      />
                    </FormControl>
                    <FormDescription>Opcional</FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            {/* Color */}
            <FormField
              control={form.control}
              name="color"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Color (opcional)</FormLabel>
                  <FormControl>
                    <ColorPicker
                      value={field.value ?? "#2563eb"}
                      onChange={field.onChange}
                    />
                  </FormControl>
                  <FormDescription>
                    Color para identificar en la agenda
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />

            {/* Actions */}
            <div className="flex justify-end gap-2">
              {onCancel && (
                <Button type="button" variant="outline" onClick={onCancel}>
                  Cancelar
                </Button>
              )}
              <Button type="submit" disabled={form.formState.isSubmitting}>
                {form.formState.isSubmitting
                  ? "Guardando..."
                  : isEditing
                  ? "Guardar cambios"
                  : "Crear servicio"}
              </Button>
            </div>
          </form>
        </Form>
      </CardContent>
    </Card>
  );
}
```
  </action>
  <verify>No TypeScript errors: `npx tsc --noEmit`</verify>
  <done>ServiceForm handles create/edit with all fields</done>
</task>

</tasks>

<verification>
1. `cat src/lib/validators/service.ts` shows schema
2. `cat src/components/services/service-form.tsx` shows form
3. `npx tsc --noEmit` succeeds
</verification>

<success_criteria>
- Service validator has all fields with proper constraints
- Form shows category dropdown with loaded categories
- Duration and price are number inputs
- ColorPicker integrated for optional color
- Handles both create and edit modes
</success_criteria>

<output>
After completion, create `.planning/phases/02-professionals-services-calendar/02-15-SUMMARY.md`
</output>
