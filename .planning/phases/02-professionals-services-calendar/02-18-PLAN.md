---
phase: 02-professionals-services-calendar
plan: 18
type: execute
wave: 5
depends_on: ["02-06"]
files_modified:
  - src/components/professionals/calendar-selector.tsx
autonomous: true

must_haves:
  truths:
    - "Shows list of shared calendars (mocked for now)"
    - "Can select a calendar ID"
    - "Shows connection status indicator"
    - "Can disconnect calendar"
  artifacts:
    - path: "src/components/professionals/calendar-selector.tsx"
      provides: "Calendar selection component"
      exports: ["CalendarSelector"]
  key_links:
    - from: "src/components/professionals/calendar-selector.tsx"
      to: "convex/professionals.ts"
      via: "useMutation"
      pattern: "useMutation.*disconnectCalendar"
---

<objective>
Create calendar selector component for Google Calendar connection.

Purpose: Admin selects which Google Calendar belongs to a professional from list of shared calendars. Per CONTEXT.md, n8n has OAuth - system only stores calendar ID.
Output: CalendarSelector component with calendar list, selection, and status display.
</objective>

<execution_context>
@C:\Users\juana\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\juana\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-professionals-services-calendar/CONTEXT.md
@convex/professionals.ts
@src/components/ui/select.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create calendar selector component</name>
  <files>src/components/professionals/calendar-selector.tsx</files>
  <action>
Create src/components/professionals/calendar-selector.tsx:

```tsx
"use client";

import { useState } from "react";
import { useMutation } from "convex/react";
import { api } from "@/convex/_generated/api";
import { Id } from "@/convex/_generated/dataModel";
import { toast } from "sonner";
import { Calendar, Check, AlertCircle, Unlink, RefreshCw } from "lucide-react";

import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";

// Mock shared calendars - in real app, this would come from n8n webhook
// Per CONTEXT.md: n8n has OAuth, we just list calendars shared with admin account
const MOCK_SHARED_CALENDARS = [
  { id: "doctor.juan@clinica.com", name: "Dr. Juan Perez" },
  { id: "doctora.maria@clinica.com", name: "Dra. Maria Garcia" },
  { id: "doctor.carlos@clinica.com", name: "Dr. Carlos Lopez" },
];

interface CalendarSelectorProps {
  professionalId: Id<"professionals">;
  professionalName: string;
  calendarId: string | null;
  onChange: (calendarId: string | undefined) => void;
}

export function CalendarSelector({
  professionalId,
  professionalName,
  calendarId,
  onChange,
}: CalendarSelectorProps) {
  const disconnectCalendar = useMutation(api.professionals.disconnectCalendar);
  const [isLoading, setIsLoading] = useState(false);
  const [showDisconnect, setShowDisconnect] = useState(false);

  // TODO: In production, fetch from n8n webhook
  const [calendars] = useState(MOCK_SHARED_CALENDARS);

  const handleSelect = (value: string) => {
    if (value === "none") {
      onChange(undefined);
    } else {
      onChange(value);
    }
  };

  const handleDisconnect = async () => {
    try {
      await disconnectCalendar({ professionalId });
      onChange(undefined);
      toast.success("Calendario desconectado");
      setShowDisconnect(false);
    } catch (error) {
      toast.error("Error al desconectar");
    }
  };

  const handleRefresh = async () => {
    setIsLoading(true);
    // TODO: Call n8n webhook to refresh calendar list
    await new Promise((resolve) => setTimeout(resolve, 1000));
    setIsLoading(false);
    toast.success("Lista de calendarios actualizada");
  };

  const isConnected = !!calendarId;
  const connectedCalendar = calendars.find((c) => c.id === calendarId);

  return (
    <>
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div>
              <CardTitle className="text-lg flex items-center gap-2">
                <Calendar className="h-5 w-5" />
                Google Calendar
              </CardTitle>
              <CardDescription>
                Conecta el calendario de {professionalName}
              </CardDescription>
            </div>
            {isConnected && (
              <Badge variant="outline" className="text-green-600 border-green-600">
                <Check className="h-3 w-3 mr-1" />
                Conectado
              </Badge>
            )}
          </div>
        </CardHeader>
        <CardContent className="space-y-4">
          {/* Instructions */}
          <div className="text-sm text-muted-foreground bg-muted p-3 rounded-lg">
            <p className="font-medium mb-1">Para conectar un calendario:</p>
            <ol className="list-decimal list-inside space-y-1">
              <li>El profesional comparte su Google Calendar con la cuenta admin</li>
              <li>Permisos requeridos: "Hacer cambios en eventos"</li>
              <li>El calendario aparecera en la lista de abajo</li>
            </ol>
          </div>

          {/* Calendar Selection */}
          <div className="flex gap-2">
            <div className="flex-1">
              <Select
                value={calendarId ?? "none"}
                onValueChange={handleSelect}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Seleccionar calendario..." />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="none">
                    <span className="text-muted-foreground">Sin calendario</span>
                  </SelectItem>
                  {calendars.map((calendar) => (
                    <SelectItem key={calendar.id} value={calendar.id}>
                      {calendar.name} ({calendar.id})
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            <Button
              variant="outline"
              size="icon"
              onClick={handleRefresh}
              disabled={isLoading}
            >
              <RefreshCw className={`h-4 w-4 ${isLoading ? "animate-spin" : ""}`} />
            </Button>
          </div>

          {/* Connection Status */}
          {isConnected && connectedCalendar && (
            <div className="flex items-center justify-between p-3 rounded-lg border bg-green-50 dark:bg-green-900/20">
              <div className="flex items-center gap-2">
                <Check className="h-5 w-5 text-green-600" />
                <div>
                  <p className="font-medium">{connectedCalendar.name}</p>
                  <p className="text-sm text-muted-foreground">
                    {connectedCalendar.id}
                  </p>
                </div>
              </div>
              <Button
                variant="ghost"
                size="sm"
                className="text-destructive hover:text-destructive"
                onClick={() => setShowDisconnect(true)}
              >
                <Unlink className="h-4 w-4 mr-1" />
                Desconectar
              </Button>
            </div>
          )}

          {/* No calendars warning */}
          {calendars.length === 0 && (
            <div className="flex items-center gap-2 p-3 rounded-lg border border-amber-200 bg-amber-50 dark:bg-amber-900/20">
              <AlertCircle className="h-5 w-5 text-amber-600" />
              <p className="text-sm">
                No se encontraron calendarios compartidos. Pide al profesional que
                comparta su calendario con la cuenta admin.
              </p>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Disconnect Confirmation */}
      <AlertDialog open={showDisconnect} onOpenChange={setShowDisconnect}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Desconectar calendario</AlertDialogTitle>
            <AlertDialogDescription>
              Â¿Estas seguro de desconectar el calendario de {professionalName}?
              Las citas existentes no se veran afectadas, pero no se sincronizaran
              nuevos eventos.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Cancelar</AlertDialogCancel>
            <AlertDialogAction
              onClick={handleDisconnect}
              className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
            >
              Desconectar
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </>
  );
}
```

Key features:
- Shows instruction for sharing calendar (per CONTEXT.md flow)
- Dropdown to select from shared calendars
- Refresh button to update list
- Connection status indicator (green badge)
- Disconnect button with confirmation
- Mock data for now (real implementation calls n8n)

**INTEGRATION NOTE (Phase 4 Scope):**
Per CONTEXT.md, the actual calendar list comes from n8n webhook that has OAuth.
This component uses MOCK data intentionally - real n8n integration is PHASE 4.

Phase 2: UI + mock data (this plan)
Phase 4: Wire n8n webhook to fetch real calendar list

The mock data allows full UI testing without n8n dependency.
  </action>
  <verify>No TypeScript errors: `npx tsc --noEmit`</verify>
  <done>CalendarSelector handles calendar ID selection with status UI</done>
</task>

</tasks>

<verification>
1. `cat src/components/professionals/calendar-selector.tsx` shows component
2. `npx tsc --noEmit` succeeds
3. Component has selection, status, disconnect UI
</verification>

<success_criteria>
- Shows instructions for sharing calendar
- Select dropdown with calendar options
- Connected status badge when calendar set
- Disconnect button with confirmation
- Refresh button for calendar list (mock for now)
</success_criteria>

<output>
After completion, create `.planning/phases/02-professionals-services-calendar/02-18-SUMMARY.md`
</output>
